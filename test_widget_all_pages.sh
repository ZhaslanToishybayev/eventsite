#!/bin/bash

# üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ AI –≤–∏–¥–∂–µ—Ç–∞ –Ω–∞ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö
echo "üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï AI –ß–ê–¢-–í–ò–î–ñ–ï–¢–ê –ù–ê –í–°–ï–• –°–¢–†–ê–ù–ò–¶–ê–•"
echo "=================================================="

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∏–¥–∂–µ—Ç–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
test_widget_on_page() {
    local url="$1"
    local page_name="$2"

    echo ""
    echo "üîç –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É: $page_name"
    echo "URL: $url"
    echo "----------------------------------------"

    # –ü–æ–ª—É—á–∞–µ–º HTML —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    response=$(curl -s "$url")
    if [ $? -ne 0 ]; then
        echo "‚ùå –°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: $url"
        return 1
    fi

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤–∏–¥–∂–µ—Ç–∞
    elements_found=0
    total_elements=5

    if echo "$response" | grep -q "chatContainer"; then
        echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–∞—Ç–∞ (chatContainer) - –ù–∞–π–¥–µ–Ω"
        ((elements_found++))
    else
        echo "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–∞—Ç–∞ (chatContainer) - –ù–µ –Ω–∞–π–¥–µ–Ω"
    fi

    if echo "$response" | grep -q "chatToggleBtn"; then
        echo "‚úÖ –ö–Ω–æ–ø–∫–∞ –≤–∏–¥–∂–µ—Ç–∞ (chatToggleBtn) - –ù–∞–π–¥–µ–Ω–∞"
        ((elements_found++))
    else
        echo "‚ùå –ö–Ω–æ–ø–∫–∞ –≤–∏–¥–∂–µ—Ç–∞ (chatToggleBtn) - –ù–µ –Ω–∞–π–¥–µ–Ω–∞"
    fi

    if echo "$response" | grep -q "chatMessages"; then
        echo "‚úÖ –û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π (chatMessages) - –ù–∞–π–¥–µ–Ω–∞"
        ((elements_found++))
    else
        echo "‚ùå –û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π (chatMessages) - –ù–µ –Ω–∞–π–¥–µ–Ω–∞"
    fi

    if echo "$response" | grep -q "chatInput"; then
        echo "‚úÖ –ü–æ–ª–µ –≤–≤–æ–¥–∞ (chatInput) - –ù–∞–π–¥–µ–Ω–æ"
        ((elements_found++))
    else
        echo "‚ùå –ü–æ–ª–µ –≤–≤–æ–¥–∞ (chatInput) - –ù–µ –Ω–∞–π–¥–µ–Ω–æ"
    fi

    if echo "$response" | grep -q "chatSendBtn"; then
        echo "‚úÖ –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ (chatSendBtn) - –ù–∞–π–¥–µ–Ω–∞"
        ((elements_found++))
    else
        echo "‚ùå –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ (chatSendBtn) - –ù–µ –Ω–∞–π–¥–µ–Ω–∞"
    fi

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ JavaScript –≤–∏–¥–∂–µ—Ç–∞
    if echo "$response" | grep -q "ai-chat-widget-v2.js"; then
        echo "‚úÖ JavaScript –≤–∏–¥–∂–µ—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω - –ù–∞–π–¥–µ–Ω"
        ((elements_found++))
    else
        echo "‚ùå JavaScript –≤–∏–¥–∂–µ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω"
    fi

    # –†–∞—Å—á–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    percentage=$((elements_found * 100 / total_elements))
    echo "üìä –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: $percentage% ($elements_found/$total_elements)"

    if [ $elements_found -eq $total_elements ]; then
        echo "‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞: $page_name - –í–∏–¥–∂–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç"
        return 0
    else
        echo "‚ùå –°—Ç—Ä–∞–Ω–∏—Ü–∞: $page_name - –í–∏–¥–∂–µ—Ç —á–∞—Å—Ç–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç"
        return 1
    fi
}

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ..."
echo ""

# –ë–∞–∑–æ–≤—ã–π URL
BASE_URL="http://localhost:8000"

# –¢–µ—Å—Ç–∏—Ä—É–µ–º—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
pages=(
    "$BASE_URL/|–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞"
    "$BASE_URL/clubs/|–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∫–ª—É–±–æ–≤"
    "$BASE_URL/widget-test/|–¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤–∏–¥–∂–µ—Ç–∞"
)

# –°—á–µ—Ç—á–∏–∫–∏
total_pages=0
working_pages=0

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
for page in "${pages[@]}"; do
    IFS='|' read -r url name <<< "$page"
    total_pages=$((total_pages + 1))

    if test_widget_on_page "$url" "$name"; then
        working_pages=$((working_pages + 1))
    fi
done

# –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
echo ""
echo "üìä –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø"
echo "====================================="
echo "–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Å—Ç—Ä–∞–Ω–∏—Ü: $total_pages"
echo "–°—Ç—Ä–∞–Ω–∏—Ü —Å —Ä–∞–±–æ—Ç–∞—é—â–∏–º –≤–∏–¥–∂–µ—Ç–æ–º: $working_pages"
echo "–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: $((working_pages * 100 / total_pages))%"

if [ $working_pages -eq $total_pages ]; then
    echo ""
    echo "üéâ –ü–û–ó–î–†–ê–í–õ–Ø–ï–ú! AI –≤–∏–¥–∂–µ—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã!"
    echo "‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"
    echo ""
    echo "üìã –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:"
    echo "  ‚Ä¢ AI –≤–∏–¥–∂–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ base.html —à–∞–±–ª–æ–Ω"
    echo "  ‚Ä¢ HTML —ç–ª–µ–º–µ–Ω—Ç—ã –≤–∏–¥–∂–µ—Ç–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –Ω–∞ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö"
    echo "  ‚Ä¢ JavaScript –≤–∏–¥–∂–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ"
    echo "  ‚Ä¢ –ö–Ω–æ–ø–∫–∞ –≤–∏–¥–∂–µ—Ç–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –ø—Ä–∞–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É"
    echo "  ‚Ä¢ –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤–∏–¥–∂–µ—Ç–∞ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
else
    echo ""
    echo "‚ùå –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–º–µ—é—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å –≤–∏–¥–∂–µ—Ç–æ–º"
    echo "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"
fi

echo ""
echo "üèÅ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!"
echo "============================"