#!/usr/bin/env python3
"""
–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ AI –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞ —Å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ–º —Ñ–æ—Ä–º
"""

import requests
import json

def test_improved_ai_form_detection():
    """–¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ñ–æ—Ä–º"""

    base_url = "http://127.0.0.1:8000"

    print("üöÄ –¢–µ—Å—Ç–∏—Ä—É–µ–º —É–ª—É—á—à–µ–Ω–Ω—ã–π AI –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç —Å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ–º —Ñ–æ—Ä–º")
    print("=" * 70)

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –∫—É–∫–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
    session = requests.Session()

    # –ü–æ–ª—É—á–∞–µ–º CSRF —Ç–æ–∫–µ–Ω —Å –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    print("\nüìù –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ CSRF —Ç–æ–∫–µ–Ω–∞")
    try:
        response = session.get(f"{base_url}/")
        if response.status_code == 200:
            import re
            match = re.search(r'<meta name="csrf-token" content="([^\"]+)"', response.text)
            if match:
                csrf_token = match.group(1)
                print(f"‚úÖ CSRF —Ç–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω: {csrf_token[:20]}...")
            else:
                print("‚ùå CSRF —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω")
                return
        else:
            print(f"‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞: {response.status_code}")
            return
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞: {e}")
        return

    # –¢–µ—Å—Ç 1: –ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª—É–±–∞ (–Ω–∞—á–∞–ª–æ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞)
    print("\nüìù –¢–µ—Å—Ç 1: –ù–∞—á–∞–ª–æ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—É–±–∞")
    try:
        response = session.post(
            f"{base_url}/api/v1/ai/simplified/interactive/chat/",
            headers={
                'Content-Type': 'application/json',
                'X-CSRFToken': csrf_token
            },
            json={
                "message": "—Å–æ–∑–¥–∞—Ç—å –∫–ª—É–±",
                "user_email": "testuser@fan-club.kz",
                "state_id": None
            }
        )

        if response.status_code == 200:
            data = response.json()
            print(f"‚úÖ –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω: {len(data.get('message', ''))} —Å–∏–º–≤–æ–ª–æ–≤")
            if "üìù –í–æ–ø—Ä–æ—Å 1" in data.get('message', ''):
                print("‚úÖ –ù–∞—á–∞–ª—Å—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å")
                state_id = data.get('state_id')
            else:
                print("‚ùå –ù–µ –Ω–∞—á–∞–ª—Å—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å")
        else:
            print(f"‚ùå –û—à–∏–±–∫–∞: {response.status_code}")

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")

    # –¢–µ—Å—Ç 2: –ó–∞–ø–æ–ª–Ω–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞ (–¥–æ–ª–∂–Ω–∞ —Å–æ–∑–¥–∞—Ç—å –∫–ª—É–±)
    print("\nüìù –¢–µ—Å—Ç 2: –ó–∞–ø–æ–ª–Ω–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞ - —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª—É–±–∞")
    filled_form_message = """–ù–∞–∑–≤–∞–Ω–∏–µ –∫–ª—É–±–∞: –®–∞—Ö–º–∞—Ç–Ω–∞—è –ê–∫–∞–¥–µ–º–∏—è ¬´–ì–∞–º–±–∏—Ç –ü—Ä–æ¬ª

–û–ø–∏—Å–∞–Ω–∏–µ –∫–ª—É–±–∞ (200+ —Å–∏–º–≤–æ–ª–æ–≤): –®–∞—Ö–º–∞—Ç–Ω–∞—è –ê–∫–∞–¥–µ–º–∏—è ¬´–ì–∞–º–±–∏—Ç –ü—Ä–æ¬ª ‚Äî —ç—Ç–æ –º–µ—Å—Ç–æ, –≥–¥–µ –ª—é–±–∏—Ç–µ–ª–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ª—é–±–æ–≥–æ —É—Ä–æ–≤–Ω—è –º–æ–≥—É—Ç —Ä–∞–∑–≤–∏—Ç—å —Å–≤–æ—ë –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ, –Ω–∞–π—Ç–∏ –µ–¥–∏–Ω–æ–º—ã—à–ª–µ–Ω–Ω–∏–∫–æ–≤ –∏ —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö. –ú—ã –ø—Ä–æ–≤–æ–¥–∏–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤ –∏ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö –∏–≥—Ä–æ–∫–æ–≤, –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä—ã, –æ–±—É—á–∞—é—â–∏–µ –ª–µ–∫—Ü–∏–∏, —Å–µ–∞–Ω—Å—ã –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –∏–≥—Ä—ã –∏ —Ä–∞–∑–±–æ—Ä—ã –ø–∞—Ä—Ç–∏–π —Å –æ–ø—ã—Ç–Ω—ã–º–∏ —Ç—Ä–µ–Ω–µ—Ä–∞–º–∏. –ù–∞—à –∫–ª—É–± —Å–æ–∑–¥–∞—ë—Ç –¥—Ä—É–∂–µ–ª—é–±–Ω—É—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É, –≥–¥–µ –∫–∞–∂–¥—ã–π –º–æ–∂–µ—Ç —Ä–∞—Å—Ç–∏, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–∞–º—è—Ç—å, –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—é –∏ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ. ¬´–ì–∞–º–±–∏—Ç –ü—Ä–æ¬ª –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –ª—é–¥–µ–π —Ä–∞–∑–Ω—ã—Ö –≤–æ–∑—Ä–∞—Å—Ç–æ–≤, –ø—Ä–µ–≤—Ä–∞—â–∞—è —à–∞—Ö–º–∞—Ç—ã –≤ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ–µ —Ö–æ–±–±–∏ –∏ –ø—É—Ç—å –∫ –ª–∏—á–Ω–æ–º—É —Ä–∞–∑–≤–∏—Ç–∏—é.

–ö–∞—Ç–µ–≥–æ—Ä–∏—è: –•–æ–±–±–∏

–ì–æ—Ä–æ–¥: –ê–ª–º–∞—Ç—ã

Email –∫–ª—É–±–∞: gambitpro.club@gmail.com"""

    try:
        response = session.post(
            f"{base_url}/api/v1/ai/simplified/interactive/chat/",
            headers={
                'Content-Type': 'application/json',
                'X-CSRFToken': csrf_token
            },
            json={
                "message": filled_form_message,
                "user_email": "testuser@fan-club.kz",
                "state_id": None  # –ù–æ–≤—ã–π state_id
            }
        )

        if response.status_code == 200:
            data = response.json()
            print(f"‚úÖ –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω: {len(data.get('message', ''))} —Å–∏–º–≤–æ–ª–æ–≤")
            print(f"üìù –°–æ–æ–±—â–µ–Ω–∏–µ: {data.get('message', '')[:200]}...")

            if "üéâ –û—Ç–ª–∏—á–Ω–æ! –ö–ª—É–±" in data.get('message', ''):
                print("‚úÖ –£–°–ü–ï–®–ù–û! AI –†–ê–°–ü–û–ó–ù–ê–õ –§–û–†–ú–£ –ò –°–û–ó–î–ê–õ –ö–õ–£–ë!")
                print("üéØ –≠—Ç–æ –∏–º–µ–Ω–Ω–æ —Ç–æ, —á—Ç–æ –Ω—É–∂–Ω–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å!")
            elif "üìù –í–æ–ø—Ä–æ—Å" in data.get('message', ''):
                print("‚ùå AI –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª —Ñ–æ—Ä–º—É - –Ω–∞—á–∞–ª –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å")
            else:
                print(f"ü§î –î—Ä—É–≥–æ–π –æ—Ç–≤–µ—Ç: {data.get('message', '')[:100]}...")

        else:
            print(f"‚ùå –û—à–∏–±–∫–∞: {response.status_code}")
            print(response.text)

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")

    # –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ñ–æ—Ä–º—ã –±–µ–∑ state_id
    print("\nüìù –¢–µ—Å—Ç 3: –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã –±–µ–∑ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ state_id")
    try:
        response = session.post(
            f"{base_url}/api/v1/ai/simplified/interactive/chat/",
            headers={
                'Content-Type': 'application/json',
                'X-CSRFToken': csrf_token
            },
            json={
                "message": filled_form_message,
                "user_email": "testuser@fan-club.kz",
                "state_id": None
            }
        )

        if response.status_code == 200:
            data = response.json()
            print(f"‚úÖ –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω: {len(data.get('message', ''))} —Å–∏–º–≤–æ–ª–æ–≤")

            if "üéâ –û—Ç–ª–∏—á–Ω–æ! –ö–ª—É–±" in data.get('message', ''):
                print("‚úÖ –§–û–†–ú–ê –†–ê–°–ü–û–ó–ù–ê–ù–ê –ë–ï–ó state_id - –û–¢–õ–ò–ß–ù–û!")
            elif "üìù –í–æ–ø—Ä–æ—Å" in data.get('message', ''):
                print("‚ùå –§–æ—Ä–º–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞ –±–µ–∑ state_id")
            else:
                print(f"ü§î –û—Ç–≤–µ—Ç: {data.get('message', '')[:100]}...")

        else:
            print(f"‚ùå –û—à–∏–±–∫–∞: {response.status_code}")

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")

    print("\n" + "=" * 70)
    print("‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ AI –∑–∞–≤–µ—Ä—à–µ–Ω–æ")

if __name__ == "__main__":
    test_improved_ai_form_detection()