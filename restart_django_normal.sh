#!/bin/bash
# üöÄ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Django —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ URL-–º–∞—Ä—à—Ä—É—Ç–∞–º–∏

echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º Django –¥–ª—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å–∞–π—Ç–∞..."
echo "=================================================="

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π Django —Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É 8001
echo "1. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π Django —Å–µ—Ä–≤–µ—Ä..."
pkill -f "python.*manage.py runserver 127.0.0.1:8001"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
sleep 2
if curl -s http://127.0.0.1:8001/ > /dev/null 2>&1; then
    echo "‚ùå –°–µ—Ä–≤–µ—Ä –≤—Å–µ –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ–º..."
    pkill -9 -f "python.*manage.py runserver 127.0.0.1:8001"
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º Django —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ URL-–º–∞—Ä—à—Ä—É—Ç–∞–º–∏
echo "2. –ó–∞–ø—É—Å–∫–∞–µ–º Django —Å –Ω–æ—Ä–º–∞–ª—å–Ω—ã–º–∏ URL-–º–∞—Ä—à—Ä—É—Ç–∞–º–∏..."
cd /var/www/myapp/eventsite
source venv/bin/activate
python manage.py runserver 127.0.0.1:8001 --insecure &

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ Django –∑–∞–ø—É—â–µ–Ω
if curl -s http://127.0.0.1:8001/ > /dev/null 2>&1; then
    echo "‚úÖ Django —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω!"

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –æ—Ç–≤–µ—Ç–∞
    echo "3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –æ—Ç–≤–µ—Ç–∞ Django..."
    response=$(curl -s http://127.0.0.1:8001/ | head -1)
    echo "–ü–µ—Ä–≤—ã–π –æ—Ç–≤–µ—Ç: $response"

    if [[ $response == *"{"* ]]; then
        echo "‚ö†Ô∏è  Django –≤—Å–µ –µ—â–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON. –ü—Ä–æ–≤–µ—Ä—è–µ–º URL-–º–∞—Ä—à—Ä—É—Ç—ã..."
        echo "   –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–∫—Ä—ã—Ç—å —Å–∞–π—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ: https://fan-club.kz"
        echo "   –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ JSON –≤–º–µ—Å—Ç–æ —Å–∞–π—Ç–∞, –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∞–π–ª—ã URL-–º–∞—Ä—à—Ä—É—Ç–æ–≤"
    else
        echo "‚úÖ Django –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTML - —Å–∞–π—Ç –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω–æ!"
    fi

    echo ""
    echo "üéØ –ì–æ—Ç–æ–≤–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∞–π—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ:"
    echo "‚Ä¢ HTTPS: https://fan-club.kz"
    echo "‚Ä¢ HTTP: http://fan-club.kz (—Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ HTTPS)"
    echo ""
    echo "üí° –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ JSON –≤–º–µ—Å—Ç–æ —Å–∞–π—Ç–∞:"
    echo "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª /var/www/myapp/eventsite/core/urls.py"
    echo "2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –µ—Å—Ç—å –∫–æ—Ä–Ω–µ–≤–æ–π –º–∞—Ä—à—Ä—É—Ç '/'"
    echo "3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ templates/base.html"

else
    echo "‚ùå Django –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è. –ü—Ä–æ–≤–µ—Ä–∏–º –æ—à–∏–±–∫–∏..."
    echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤:"
    tail -10 /tmp/django_log.log 2>/dev/null || echo "–õ–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
fi