#!/bin/bash

# ðŸ” SSL Diagnostic Script for fan-club.kz
# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ¸ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð² Ð¸ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ

echo "ðŸ” Ð—Ð°Ð¿ÑƒÑÐº Ð´Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ¸ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð² Ð´Ð»Ñ fan-club.kz..."
echo "================================================================"

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿ÐµÑ‡Ð°Ñ‚Ð¸ Ñ€Ð°Ð·Ð´ÐµÐ»Ð¸Ñ‚ÐµÐ»ÐµÐ¹
print_separator() {
    echo "----------------------------------------------------------------"
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
success_msg() {
    echo -e "${GREEN}âœ… $1${NC}"
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ¸
error_msg() {
    echo -e "${RED}âŒ $1${NC}"
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ñ
warning_msg() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸
info_msg() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° nginx
check_nginx_status() {
    print_separator
    echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° nginx..."

    if systemctl is-active --quiet nginx; then
        success_msg "nginx Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚"
        nginx_status="running"
    else
        error_msg "nginx Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚"
        nginx_status="stopped"
    fi

    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ nginx
    echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ nginx..."
    if nginx -t 2>&1 | grep -q "syntax is ok"; then
        success_msg "Ð¡Ð¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚ÐµÐ½"
        nginx_config_ok=true
    else
        error_msg "Ð¡Ð¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð¾ÑˆÐ¸Ð±ÐºÐ¸"
        nginx_config_ok=false
        nginx -t
    fi
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²
check_ssl_certificates() {
    print_separator
    echo "ðŸ”’ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²..."

    cert_path="/etc/letsencrypt/live/fan-club.kz"
    fullchain_cert="$cert_path/fullchain.pem"
    privkey_cert="$cert_path/privkey.pem"

    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ñ Ñ„Ð°Ð¹Ð»Ð¾Ð² ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²
    if [[ -f "$fullchain_cert" ]]; then
        success_msg "ÐÐ°Ð¹Ð´ÐµÐ½ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚: $fullchain_cert"
        fullchain_exists=true
    else
        error_msg "SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½: $fullchain_cert"
        fullchain_exists=false
    fi

    if [[ -f "$privkey_cert" ]]; then
        success_msg "ÐÐ°Ð¹Ð´ÐµÐ½ SSL Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡: $privkey_cert"
        privkey_exists=true
    else
        error_msg "SSL Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½: $privkey_cert"
        privkey_exists=false
    fi

    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²Ð°Ð»Ð¸Ð´Ð½Ð¾ÑÑ‚Ð¸ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²
    if [[ $fullchain_exists == true ]]; then
        echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ€Ð¾ÐºÐ° Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°..."
        cert_expiry=$(openssl x509 -enddate -noout -in "$fullchain_cert" 2>/dev/null | cut -d= -f2)
        if [[ $? -eq 0 ]]; then
            expiry_date=$(date -d "$cert_expiry" '+%d.%m.%Y %H:%M:%S')
            current_date=$(date '+%d.%m.%Y %H:%M:%S')

            if [[ $(date -d "$cert_expiry" +%s) -gt $(date +%s) ]]; then
                success_msg "Ð¡ÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÐµÐ½ Ð´Ð¾: $expiry_date"
                cert_valid=true
            else
                error_msg "Ð¡ÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ Ð¿Ñ€Ð¾ÑÑ€Ð¾Ñ‡ÐµÐ½! Ð¡Ñ€Ð¾Ðº Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ: $expiry_date"
                cert_valid=false
            fi
        else
            error_msg "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÑ€Ð¾Ðº Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°"
            cert_valid=false
        fi
    fi

    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ nginx Ð½Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ SSL
    echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Ð½Ð° SSL..."
    nginx_config="/etc/nginx/sites-enabled/fan-club.kz"
    if [[ -f "$nginx_config" ]] && grep -q "ssl_certificate" "$nginx_config"; then
        info_msg "Nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹"
        nginx_uses_ssl=true
    else
        info_msg "Nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð½Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ SSL"
        nginx_uses_ssl=false
    fi
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸ ÑÐ°Ð¹Ñ‚Ð°
check_website_access() {
    print_separator
    echo "ðŸŒ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸ ÑÐ°Ð¹Ñ‚Ð°..."

    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Django ÑÐµÑ€Ð²ÐµÑ€Ð°
    echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Django ÑÐµÑ€Ð²ÐµÑ€Ð° Ð½Ð° localhost:8000..."
    if curl -s --connect-timeout 5 http://localhost:8000 > /dev/null; then
        success_msg "Django ÑÐµÑ€Ð²ÐµÑ€ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð½Ð° localhost:8000"
        django_ok=true
    else
        error_msg "Django ÑÐµÑ€Ð²ÐµÑ€ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð½Ð° localhost:8000"
        django_ok=false
    fi

    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° AI API
    echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° AI API..."
    if curl -s --connect-timeout 5 http://localhost:8000/api/v1/ai/simplified/interactive/status/ > /dev/null; then
        success_msg "AI API Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½"
        ai_api_ok=true
    else
        error_msg "AI API Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½"
        ai_api_ok=false
    fi

    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‡ÐµÑ€ÐµÐ· nginx (ÐµÑÐ»Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚)
    if [[ $nginx_status == "running" ]]; then
        echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ°Ð¹Ñ‚Ð° Ñ‡ÐµÑ€ÐµÐ· nginx..."
        if curl -s --connect-timeout 5 http://fan-club.kz > /dev/null; then
            success_msg "Ð¡Ð°Ð¹Ñ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ñ‡ÐµÑ€ÐµÐ· nginx (HTTP)"
            nginx_http_ok=true
        else
            error_msg "Ð¡Ð°Ð¹Ñ‚ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ñ‡ÐµÑ€ÐµÐ· nginx (HTTP)"
            nginx_http_ok=false
        fi

        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° HTTPS
        if curl -s --connect-timeout 5 https://fan-club.kz > /dev/null; then
            success_msg "Ð¡Ð°Ð¹Ñ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ñ‡ÐµÑ€ÐµÐ· nginx (HTTPS)"
            nginx_https_ok=true
        else
            error_msg "Ð¡Ð°Ð¹Ñ‚ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ñ‡ÐµÑ€ÐµÐ· nginx (HTTPS)"
            nginx_https_ok=false
        fi
    fi
}

# ÐÐ½Ð°Ð»Ð¸Ð· Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹
analyze_problem() {
    print_separator
    echo "ðŸ” ÐÐ½Ð°Ð»Ð¸Ð· Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼..."

    issues=()
    solutions=()

    if [[ $nginx_status != "running" ]]; then
        issues+=("nginx Ð½Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½")
        solutions+=("systemctl start nginx")
    fi

    if [[ $nginx_config_ok == false ]]; then
        issues+=("Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð² ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ nginx")
        solutions+=("Ð¸ÑÐ¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ nginx")
    fi

    if [[ $django_ok == false ]]; then
        issues+=("Django ÑÐµÑ€Ð²ÐµÑ€ Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚")
        solutions+=("Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Django: source venv/bin/activate && python manage.py runserver 0.0.0.0:8000")
    fi

    if [[ $ai_api_ok == false ]]; then
        issues+=("AI API Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚")
        solutions+=("Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Django ÑÐµÑ€Ð²ÐµÑ€ Ð¸ AI Ð¼Ð¾Ð´ÑƒÐ»Ð¸")
    fi

    if [[ $nginx_uses_ssl == true ]] && ([[ $fullchain_exists == false ]] || [[ $privkey_exists == false ]] || [[ $cert_valid == false ]]); then
        issues+=("SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚ Ð¸Ð»Ð¸ Ð½ÐµÐ´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹")
        solutions+=("ssl_fix")
    fi

    if [[ $nginx_https_ok == false ]] && [[ $django_ok == true ]] && [[ $nginx_status == "running" ]]; then
        issues+=("HTTPS Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½, Ð½Ð¾ Ð±ÑÐºÐµÐ½Ð´ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚")
        solutions+=("ssl_fix")
    fi

    # Ð’Ñ‹Ð²Ð¾Ð´ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼
    if [[ ${#issues[@]} -eq 0 ]]; then
        success_msg "ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼ Ð½Ðµ Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð¾! Ð¡Ð°Ð¹Ñ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ð¾."
    else
        echo ""
        error_msg "ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹:"
        for issue in "${issues[@]}"; do
            echo "  - $issue"
        done

        echo ""
        warning_msg "ÐŸÑ€ÐµÐ´Ð»Ð°Ð³Ð°ÐµÐ¼Ñ‹Ðµ Ñ€ÐµÑˆÐµÐ½Ð¸Ñ:"
        for solution in "${solutions[@]}"; do
            if [[ $solution == "ssl_fix" ]]; then
                echo "  - Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ SSL Ñ„Ð¸ÐºÑ (Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸)"
            else
                echo "  - $solution"
            fi
        done
    fi
}

# ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ SSL Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼
fix_ssl_problems() {
    print_separator
    echo "ðŸ”§ ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ SSL Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼..."

    read -p "Ð’Ñ‹ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        info_msg "ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½Ð¾"
        return
    fi

    # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ð¹ ÐºÐ¾Ð¿Ð¸Ð¸ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
    backup_dir="/etc/nginx/backup_$(date +%Y%m%d_%H%M%S)"
    echo "ðŸ“‹ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ð¹ ÐºÐ¾Ð¿Ð¸Ð¸ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸..."
    sudo mkdir -p "$backup_dir"
    sudo cp /etc/nginx/sites-available/fan-club.kz "$backup_dir/" 2>/dev/null || true
    sudo cp /etc/nginx/sites-enabled/fan-club.kz "$backup_dir/" 2>/dev/null || true
    success_msg "Ð ÐµÐ·ÐµÑ€Ð²Ð½Ð°Ñ ÐºÐ¾Ð¿Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð°: $backup_dir"

    # Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 1: ÐŸÑ€Ð¾ÑÑ‚Ð°Ñ HTTP ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ (Ð±ÐµÐ· SSL)
    echo ""
    echo "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ:"
    echo "1. ÐŸÑ€Ð¾ÑÑ‚Ð°Ñ HTTP ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ (Ð±ÐµÐ· SSL) - Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ðµ Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ"
    echo "2. ÐŸÐ¾Ð»Ð½Ð°Ñ SSL Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ñ Let's Encrypt"
    echo "3. ÐžÑ‚Ð¼ÐµÐ½Ð°"

    read -p "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð²Ñ‹Ð±Ð¾Ñ€ (1-3): " -n 1 -r
    echo

    case $REPLY in
        1)
            fix_with_http
            ;;
        2)
            fix_with_ssl
            ;;
        3)
            info_msg "Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½Ð¾"
            ;;
        *)
            error_msg "ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð²Ñ‹Ð±Ð¾Ñ€"
            ;;
    esac
}

# Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ HTTP ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÐµÐ¹
fix_with_http() {
    echo "ðŸ”§ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° HTTP ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸..."

    # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ñ€Ð¾ÑÑ‚ÑƒÑŽ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
    if [[ -f "/var/www/myapp/eventsite/nginx_simple_config" ]]; then
        sudo cp /var/www/myapp/eventsite/nginx_simple_config /etc/nginx/sites-available/fan-club
        success_msg "Ð¡ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð° Ð¿Ñ€Ð¾ÑÑ‚Ð°Ñ HTTP ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ"
    else
        error_msg "Ð¤Ð°Ð¹Ð» Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ..."

        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÑÑ‚ÑƒÑŽ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ
        sudo tee /etc/nginx/sites-available/fan-club > /dev/null << 'EOF'
# ÐŸÑ€Ð¾ÑÑ‚Ð°Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ nginx Ð±ÐµÐ· SSL
server {
    listen 80;
    server_name fan-club.kz www.fan-club.kz;

    # ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Ð¡Ñ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
    location /static/ {
        alias /var/www/myapp/eventsite/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # ÐœÐµÐ´Ð¸Ð° Ñ„Ð°Ð¹Ð»Ñ‹
    location /media/ {
        alias /var/www/myapp/eventsite/media/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ð¾ÑÐ¿Ð¾ÑÐ¾Ð±Ð½Ð¾ÑÑ‚Ð¸
    location /health/ {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ - Ð·Ð°Ð¿Ñ€ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº ÑÐºÑ€Ñ‹Ñ‚Ñ‹Ð¼ Ñ„Ð°Ð¹Ð»Ð°Ð¼
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# Ð ÐµÐ´Ð¸Ñ€ÐµÐºÑ‚ Ñ www Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð´Ð¾Ð¼ÐµÐ½
server {
    listen 80;
    server_name www.fan-club.kz;
    return 301 http://fan-club.kz$request_uri;
}
EOF
        success_msg "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð° Ð¿Ñ€Ð¾ÑÑ‚Ð°Ñ HTTP ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ"
    fi

    # ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼ Ð½Ð¾Ð²ÑƒÑŽ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
    sudo ln -sf /etc/nginx/sites-available/fan-club /etc/nginx/sites-enabled/
    sudo rm -f /etc/nginx/sites-enabled/fan-club.kz

    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
    if nginx -t; then
        success_msg "ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ nginx Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐµÐ½Ð°"
        # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ nginx
        sudo systemctl restart nginx
        if systemctl is-active --quiet nginx; then
            success_msg "nginx Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑ‰ÐµÐ½"
            echo ""
            success_msg "âœ… HTTP ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°! Ð¡Ð°Ð¹Ñ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ http://fan-club.kz"
        else
            error_msg "nginx Ð½Ðµ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð»ÑÑ Ð¿Ð¾ÑÐ»Ðµ Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸"
        fi
    else
        error_msg "ÐžÑˆÐ¸Ð±ÐºÐ° Ð² ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ nginx"
    fi
}

# Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ SSL
fix_with_ssl() {
    echo "ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° SSL Ñ Let's Encrypt..."

    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ certbot
    if ! command -v certbot &> /dev/null; then
        echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° certbot..."
        sudo apt update
        sudo apt install -y certbot
    fi

    # ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° nginx Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°
    echo "ðŸ›‘ ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° nginx Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°..."
    sudo systemctl stop nginx

    # ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°
    echo "ðŸ”’ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°..."
    if sudo certbot certonly --standalone -d fan-club.kz -d www.fan-club.kz --non-interactive --agree-tos --email admin@fan-club.kz; then
        success_msg "SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½"

        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ SSL ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
        sudo tee /etc/nginx/sites-available/fan-club > /dev/null << 'EOF'
# HTTP Ñ€ÐµÐ´Ð¸Ñ€ÐµÐºÑ‚ Ð½Ð° HTTPS
server {
    listen 80;
    server_name fan-club.kz www.fan-club.kz;
    return 301 https://$server_name$request_uri;
}

# HTTPS ÑÐµÑ€Ð²ÐµÑ€
server {
    listen 443 ssl http2;
    server_name fan-club.kz www.fan-club.kz;

    ssl_certificate /etc/letsencrypt/live/fan-club.kz/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/fan-club.kz/privkey.pem;

    # Modern SSL configuration
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";

    # Static Files
    location /static/ {
        alias /var/www/myapp/eventsite/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # Media Files
    location /media/ {
        alias /var/www/myapp/eventsite/media/;
        expires 1y;
        add_header Cache-Control "public";
        access_log off;
    }

    # Main Application
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_read_timeout 300s;
        proxy_connect_timeout 300s;
    }

    # Health Check
    location /health/ {
        access_log off;
        proxy_pass http://127.0.0.1:8000/health/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Security - Deny access to hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Let's Encrypt challenge
    location /.well-known/acme-challenge/ {
        root /var/www/html;
        allow all;
    }

    # Logging
    access_log /var/log/nginx/fan-club.kz.access.log;
    error_log /var/log/nginx/fan-club.kz.error.log;
}
EOF

        success_msg "SSL ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð°"

        # ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
        sudo ln -sf /etc/nginx/sites-available/fan-club /etc/nginx/sites-enabled/
        sudo rm -f /etc/nginx/sites-enabled/fan-club.kz

        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ nginx
        if nginx -t; then
            sudo systemctl start nginx
            if systemctl is-active --quiet nginx; then
                success_msg "nginx Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ñ SSL"
                echo ""
                success_msg "âœ… SSL ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°! Ð¡Ð°Ð¹Ñ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ https://fan-club.kz"
            else
                error_msg "nginx Ð½Ðµ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð»ÑÑ"
            fi
        else
            error_msg "ÐžÑˆÐ¸Ð±ÐºÐ° Ð² SSL ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ nginx"
        fi
    else
        error_msg "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚"
        # Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ nginx Ð² Ð¸ÑÑ…Ð¾Ð´Ð½Ð¾Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ
        sudo systemctl start nginx
    fi
}

# ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ
main() {
    echo "ðŸ” Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ° SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð² Ð¸ nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸"
    echo "Ð”Ð°Ñ‚Ð°: $(date)"
    echo ""

    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð°Ð² root
    if [[ $EUID -eq 0 ]]; then
        error_msg "Ð­Ñ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð½Ðµ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒÑÑ Ð¾Ñ‚ root. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ sudo Ð´Ð»Ñ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ñ… ÐºÐ¾Ð¼Ð°Ð½Ð´."
        exit 1
    fi

    # Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¾Ðº
    check_nginx_status
    check_ssl_certificates
    check_website_access
    analyze_problem

    # ÐŸÑ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ SSL Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹
    if [[ " ${solutions[@]} " =~ " ssl_fix " ]]; then
        echo ""
        fix_ssl_problems
    fi

    print_separator
    echo "ðŸ Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
    echo ""
    echo "ðŸ’¡ Ð•ÑÐ»Ð¸ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ð¾ÑÑ‚Ð°Ð»Ð¸ÑÑŒ, Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ:"
    echo "   - Django ÑÐµÑ€Ð²ÐµÑ€: source venv/bin/activate && python manage.py runserver 0.0.0.0:8000"
    echo "   - Ð›Ð¾Ð³Ð¸ nginx: sudo tail -f /var/log/nginx/error.log"
    echo "   - Ð¡Ñ‚Ð°Ñ‚ÑƒÑ nginx: sudo systemctl status nginx"
}

# Ð—Ð°Ð¿ÑƒÑÐº Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸
main