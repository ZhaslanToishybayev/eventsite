<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widget Debug Test</title>
    <link rel="stylesheet" href="/static/css/ai-chat-widget-v2.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry.error { color: red; }
        .log-entry.success { color: green; }
        .log-entry.info { color: blue; }
        .force-create-btn {
            background: #6366f1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .force-create-btn:hover {
            background: #4f46e5;
        }
    </style>
</head>
<body>
    <h1>üîç –û—Ç–ª–∞–¥–∫–∞ AI –í–∏–¥–∂–µ—Ç–∞</h1>

    <div class="debug-panel">
        <h3>üìã –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h3>
        <div id="system-status">–ü—Ä–æ–≤–µ—Ä–∫–∞...</div>
        <div id="debug-log"></div>

        <h3>üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
        <button class="force-create-btn" onclick="forceCreateWidget()">–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞—Ç—å –≤–∏–¥–∂–µ—Ç</button>
        <button class="force-create-btn" onclick="forceShowWidget()">–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É</button>
        <button class="force-create-btn" onclick="checkDOMElements()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å DOM —ç–ª–µ–º–µ–Ω—Ç—ã</button>
        <button class="force-create-btn" onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
    </div>

    <script src="/static/js/ai-chat-widget-v2.js"></script>

    <script>
        let logCounter = 0;

        function addLog(message, type = 'info') {
            const logDiv = document.getElementById('debug-log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `${++logCounter}. ${new Date().toLocaleTimeString()}: ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function checkSystemStatus() {
            const status = document.getElementById('system-status');
            let statusHTML = '<ul>';

            statusHTML += `<li>AIChatWidget –∫–ª–∞—Å—Å: ${typeof AIChatWidget !== 'undefined' ? '‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω' : '‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω'}</li>`;
            statusHTML += `<li>initAIChatWidgetV2 —Ñ—É–Ω–∫—Ü–∏—è: ${typeof initAIChatWidgetV2 === 'function' ? '‚úÖ –î–æ—Å—Ç—É–ø–Ω–∞' : '‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞'}</li>`;
            statusHTML += `<li>window.aiChatWidgetV2: ${window.aiChatWidgetV2 ? '‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω' : '‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω'}</li>`;
            statusHTML += `<li>window.aiChat: ${window.aiChat ? '‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω' : '‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω'}</li>`;
            statusHTML += `<li>CSS —Ñ–∞–π–ª: ${document.querySelector('link[href*="ai-chat-widget"]') ? '‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω' : '‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω'}</li>`;
            statusHTML += `<li>JS —Ñ–∞–π–ª: ${document.querySelector('script[src*="ai-chat-widget"]') ? '‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω' : '‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω'}</li>`;

            statusHTML += '</ul>';
            status.innerHTML = statusHTML;

            // Check DOM elements
            setTimeout(checkDOMElements, 1000);
        }

        function checkDOMElements() {
            const widget = document.getElementById('ai-chat-widget');
            const button = document.getElementById('chatToggleBtn');
            const container = document.getElementById('chatContainer');

            addLog(`üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤:`);
            addLog(`  - –í–∏–¥–∂–µ—Ç (#ai-chat-widget): ${widget ? '‚úÖ –ù–∞–π–¥–µ–Ω' : '‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω'}`, widget ? 'success' : 'error');
            addLog(`  - –ö–Ω–æ–ø–∫–∞ (#chatToggleBtn): ${button ? '‚úÖ –ù–∞–π–¥–µ–Ω–∞' : '‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞'}`, button ? 'success' : 'error');
            addLog(`  - –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä (#chatContainer): ${container ? '‚úÖ –ù–∞–π–¥–µ–Ω' : '‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω'}`, container ? 'success' : 'error');

            if (widget) {
                const styles = window.getComputedStyle(widget);
                addLog(`üé® –°—Ç–∏–ª–∏ –≤–∏–¥–∂–µ—Ç–∞:`, 'info');
                addLog(`  - Display: ${styles.display}`, 'info');
                addLog(`  - Visibility: ${styles.visibility}`, 'info');
                addLog(`  - Opacity: ${styles.opacity}`, 'info');
                addLog(`  - Position: ${styles.position}`, 'info');
                addLog(`  - Bottom: ${styles.bottom}`, 'info');
                addLog(`  - Right: ${styles.right}`, 'info');
                addLog(`  - Z-Index: ${styles.zIndex}`, 'info');
                addLog(`  - Width: ${styles.width}`, 'info');
                addLog(`  - Height: ${styles.height}`, 'info');

                // Check bounding rect
                const rect = widget.getBoundingClientRect();
                addLog(`üìê –ü–æ–∑–∏—Ü–∏—è –∏ —Ä–∞–∑–º–µ—Ä:`, 'info');
                addLog(`  - Top: ${rect.top}`, 'info');
                addLog(`  - Left: ${rect.left}`, 'info');
                addLog(`  - Width: ${rect.width}`, 'info');
                addLog(`  - Height: ${rect.height}`, 'info');
                addLog(`  - –í–∏–¥–∏–º: ${rect.width > 0 && rect.height > 0 ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç'}`, rect.width > 0 && rect.height > 0 ? 'success' : 'error');
            }

            if (button) {
                const styles = window.getComputedStyle(button);
                addLog(`üé® –°—Ç–∏–ª–∏ –∫–Ω–æ–ø–∫–∏:`, 'info');
                addLog(`  - Display: ${styles.display}`, 'info');
                addLog(`  - Visibility: ${styles.visibility}`, 'info');
                addLog(`  - Opacity: ${styles.opacity}`, 'info');
                addLog(`  - Position: ${styles.position}`, 'info');
                addLog(`  - Width: ${styles.width}`, 'info');
                addLog(`  - Height: ${styles.height}`, 'info');
                addLog(`  - Background: ${styles.background}`, 'info');

                const rect = button.getBoundingClientRect();
                addLog(`üìê –ü–æ–∑–∏—Ü–∏—è –∫–Ω–æ–ø–∫–∏:`, 'info');
                addLog(`  - Top: ${rect.top}`, 'info');
                addLog(`  - Left: ${rect.left}`, 'info');
                addLog(`  - Width: ${rect.width}`, 'info');
                addLog(`  - Height: ${rect.height}`, 'info');
                addLog(`  - –í–∏–¥–∏–º–∞: ${rect.width > 0 && rect.height > 0 ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç'}`, rect.width > 0 && rect.height > 0 ? 'success' : 'error');
            }
        }

        function forceCreateWidget() {
            addLog('üîß –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–¥–∂–µ—Ç–∞...', 'info');

            try {
                if (typeof initAIChatWidgetV2 === 'function') {
                    const widget = initAIChatWidgetV2();
                    addLog(`‚úÖ –í–∏–¥–∂–µ—Ç —Å–æ–∑–¥–∞–Ω: ${widget ? '–î–∞' : '–ù–µ—Ç'}`, widget ? 'success' : 'error');

                    setTimeout(() => {
                        checkDOMElements();
                    }, 1000);
                } else {
                    addLog('‚ùå –§—É–Ω–∫—Ü–∏—è initAIChatWidgetV2 –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
                }
            } catch (error) {
                addLog(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≤–∏–¥–∂–µ—Ç–∞: ${error.message}`, 'error');
            }
        }

        function forceShowWidget() {
            addLog('üëÅÔ∏è –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏...', 'info');

            const button = document.getElementById('chatToggleBtn');
            if (button) {
                button.style.cssText = `
                    display: flex !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    position: fixed !important;
                    bottom: 30px !important;
                    right: 30px !important;
                    width: 64px !important;
                    height: 64px !important;
                    z-index: 9999 !important;
                    background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%) !important;
                    border-radius: 50% !important;
                    border: none !important;
                    color: white !important;
                    font-size: 28px !important;
                    cursor: pointer !important;
                    box-shadow: 0 10px 30px rgba(99, 102, 241, 0.4) !important;
                    align-items: center !important;
                    justify-content: center !important;
                `;
                addLog('‚úÖ –ö–Ω–æ–ø–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∞', 'success');
            } else {
                addLog('‚ùå –ö–Ω–æ–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ DOM', 'error');
            }
        }

        function clearLog() {
            document.getElementById('debug-log').innerHTML = '';
            logCounter = 0;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            addLog('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
            setTimeout(() => {
                checkSystemStatus();
                addLog('üîç –ù–∞—á–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'info');
            }, 1000);

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
            setInterval(() => {
                addLog('‚è∞ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞...', 'info');
                checkDOMElements();
            }, 5000);
        });

        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
        window.addEventListener('error', function(event) {
            addLog(`‚ùå JavaScript –æ—à–∏–±–∫–∞: ${event.error.message} –≤ ${event.filename}:${event.lineno}`, 'error');
        });

        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
        window.addEventListener('unhandledrejection', function(event) {
            addLog(`‚ö†Ô∏è –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π Promise: ${event.reason}`, 'error');
        });
    </script>
</body>
</html>