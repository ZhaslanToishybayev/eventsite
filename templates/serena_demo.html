<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Serena AI Demo - UnitySphere</title>
    <meta name="csrf-token" content="test-token">
    <script src="https://kit.fontawesome.com/77b427ccd5.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css?family=Poppins:100,200,400,300,500,600,700" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/ai-chat-widget.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Poppins', sans-serif;
            color: white;
            padding: 20px;
        }

        .demo-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .serena-section {
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 20px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online { background: #4ade80; }
        .status-offline { background: #f87171; }
        .status-checking { background: #fbbf24; animation: pulse 1s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .serena-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .control-group {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.9);
            color: #333;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .result-area {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            min-height: 100px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .file-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }

        .file-option {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .file-option:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .file-option.selected {
            background: rgba(102, 126, 234, 0.5);
            border: 2px solid #667eea;
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <h1>ü§ñ Serena AI Demo - UnitySphere</h1>

        <div class="serena-section">
            <h2>üì° –°—Ç–∞—Ç—É—Å Serena AI</h2>
            <div id="status-check">
                <span class="status-indicator status-checking"></span>
                <span>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞...</span>
            </div>
        </div>

        <div class="serena-section">
            <h2>üîç –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞</h2>
            <div class="serena-controls">
                <div class="control-group">
                    <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:</h3>
                    <div class="file-selector" id="fileSelector">
                        <div class="file-option" data-file="accounts/models.py">
                            üìÑ accounts/models.py
                        </div>
                        <div class="file-option" data-file="clubs/models.py">
                            üìÑ clubs/models.py
                        </div>
                        <div class="file-option" data-file="ai_consultant/services.py">
                            üìÑ ai_consultant/services.py
                        </div>
                        <div class="file-option" data-file="core/settings.py">
                            üìÑ core/settings.py
                        </div>
                        <div class="file-option" data-file="clubs/views.py">
                            üìÑ clubs/views.py
                        </div>
                        <div class="file-option" data-file="ai_consultant/models.py">
                            üìÑ ai_consultant/models.py
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <h3>–¢–∏–ø –∞–Ω–∞–ª–∏–∑–∞:</h3>
                    <div class="form-group">
                        <select id="analysisType">
                            <option value="structure">üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞</option>
                            <option value="documentation">üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</option>
                            <option value="improvement">üí° –£–ª—É—á—à–µ–Ω–∏—è</option>
                        </select>
                    </div>
                    <div class="form-group" id="improvementGroup" style="display: none;">
                        <label>–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:</label>
                        <textarea id="issueDescription" placeholder="–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –Ω—É–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å..." rows="3"></textarea>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin: 20px 0;">
                <button id="analyzeButton" onclick="analyzeCode()">
                    üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
                </button>
            </div>

            <div class="loading" id="loadingIndicator">
                <div class="spinner"></div>
                <div>–ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ —Å –ø–æ–º–æ—â—å—é Serena AI...</div>
            </div>

            <div class="result-area" id="resultArea">
                –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å...
            </div>
        </div>

        <div class="serena-section">
            <h2>üîç –ü–æ–∏—Å–∫ —Å–∏–º–≤–æ–ª–æ–≤</h2>
            <div class="serena-controls">
                <div class="control-group">
                    <div class="form-group">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∏–º–≤–æ–ª–∞:</label>
                        <input type="text" id="symbolName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: User, Club, ChatSession">
                    </div>
                    <div class="form-group">
                        <label>–§–∞–π–ª (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):label>
                        <input type="text" id="symbolFile" placeholder="accounts/models.py">
                    </div>
                    <button onclick="searchSymbol()">
                        üîç –ù–∞–π—Ç–∏ —Å–∏–º–≤–æ–ª
                    </button>
                </div>
            </div>

            <div class="result-area" id="symbolResult">
                –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å...
            </div>
        </div>

        <div class="serena-section">
            <h2>üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ</h2>
            <button onclick="getProjectInfo()">
                üìã –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–µ–∫—Ç–µ
            </button>
            <div class="result-area" id="projectResult">
                –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            checkSerenaStatus();
            setupFileSelector();
            setupAnalysisTypeSelector();
        });

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ Serena
        async function checkSerenaStatus() {
            const statusDiv = document.getElementById('status-check');

            try {
                const response = await fetch('/api/v1/ai/serena/status/');
                const data = await response.json();

                if (data.success && data.available) {
                    statusDiv.innerHTML = `
                        <span class="status-indicator status-online"></span>
                        <span>Serena AI –æ–Ω–ª–∞–π–Ω –∏ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!</span>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <span class="status-indicator status-offline"></span>
                        <span>Serena AI –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</span>
                    `;
                }
            } catch (error) {
                statusDiv.innerHTML = `
                    <span class="status-indicator status-offline"></span>
                    <span>–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Serena AI</span>
                `;
            }
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤
        function setupFileSelector() {
            const fileOptions = document.querySelectorAll('.file-option');

            fileOptions.forEach(option => {
                option.addEventListener('click', function() {
                    fileOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedFile = this.dataset.file;
                });
            });

            // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π —Ñ–∞–π–ª –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            if (fileOptions.length > 0) {
                fileOptions[0].click();
            }
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ —Ç–∏–ø–∞ –∞–Ω–∞–ª–∏–∑–∞
        function setupAnalysisTypeSelector() {
            const analysisType = document.getElementById('analysisType');
            const improvementGroup = document.getElementById('improvementGroup');

            analysisType.addEventListener('change', function() {
                if (this.value === 'improvement') {
                    improvementGroup.style.display = 'block';
                } else {
                    improvementGroup.style.display = 'none';
                }
            });
        }

        // –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞
        async function analyzeCode() {
            if (!selectedFile) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞');
                return;
            }

            const analysisType = document.getElementById('analysisType').value;
            const issueDescription = document.getElementById('issueDescription').value;
            const loadingIndicator = document.getElementById('loadingIndicator');
            const resultArea = document.getElementById('resultArea');
            const analyzeButton = document.getElementById('analyzeButton');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            loadingIndicator.classList.add('active');
            analyzeButton.disabled = true;
            resultArea.textContent = '';

            try {
                const formData = new FormData();
                formData.append('file_path', selectedFile);
                formData.append('analysis_type', analysisType);
                if (analysisType === 'improvement') {
                    formData.append('issue_description', issueDescription);
                }

                // –î–ª—è CSRF –∑–∞—â–∏—Ç—ã
                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

                const response = await fetch('/api/v1/ai/serena/analyze/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                });

                const data = await response.json();

                if (data.success) {
                    resultArea.textContent = data.result || '–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω, –Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—É—Å—Ç';
                } else {
                    resultArea.textContent = `–û—à–∏–±–∫–∞: ${data.error}`;
                }
            } catch (error) {
                resultArea.textContent = `–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}`;
            } finally {
                loadingIndicator.classList.remove('active');
                analyzeButton.disabled = false;
            }
        }

        // –ü–æ–∏—Å–∫ —Å–∏–º–≤–æ–ª–∞
        async function searchSymbol() {
            const symbolName = document.getElementById('symbolName').value;
            const symbolFile = document.getElementById('symbolFile').value;
            const resultArea = document.getElementById('symbolResult');

            if (!symbolName) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∏–º–≤–æ–ª–∞');
                return;
            }

            resultArea.textContent = '–ü–æ–∏—Å–∫ —Å–∏–º–≤–æ–ª–∞...';

            try {
                const params = new URLSearchParams({
                    symbol_name: symbolName
                });

                if (symbolFile) {
                    params.append('file_path', symbolFile);
                }

                const response = await fetch(`/api/v1/ai/serena/symbol/?${params}`);
                const data = await response.json();

                if (data.success) {
                    resultArea.textContent = JSON.stringify(data.result, null, 2);
                } else {
                    resultArea.textContent = `–û—à–∏–±–∫–∞: ${data.error}`;
                }
            } catch (error) {
                resultArea.textContent = `–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}`;
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ–µ–∫—Ç–µ
        async function getProjectInfo() {
            const resultArea = document.getElementById('projectResult');

            resultArea.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ–µ–∫—Ç–µ...';

            try {
                const response = await fetch('/api/v1/ai/serena/project/');
                const data = await response.json();

                if (data.success) {
                    resultArea.textContent = JSON.stringify(data.project_info, null, 2);
                } else {
                    resultArea.textContent = `–û—à–∏–±–∫–∞: ${data.error}`;
                }
            } catch (error) {
                resultArea.textContent = `–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}`;
            }
        }
    </script>
</body>
</html>