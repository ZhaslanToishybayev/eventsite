<!-- ü§ñ –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô MAIN CHAT WIDGET - –ï–¥–∏–Ω—ã–π –¥–ª—è –≤—Å–µ–≥–æ —Å–∞–π—Ç–∞ -->
<style>
    /* –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞ */
    .fixed-chat-widget-btn {
        position: fixed !important;
        bottom: 25px !important;
        right: 25px !important;
        width: 70px !important;
        height: 70px !important;
        border-radius: 50% !important;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        border: 4px solid #ffffff !important;
        color: #ffffff !important;
        font-size: 28px !important;
        cursor: pointer !important;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25) !important;
        transition: all 0.3s ease !important;
        z-index: 999999999 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        outline: none !important;
        animation: pulse 3s infinite !important;
        opacity: 1 !important;
        visibility: visible !important;
        margin: 0 !important;
        padding: 0 !important;
        font-family: Arial, sans-serif !important;
        line-height: 1 !important;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1) !important; }
        50% { transform: scale(1.05) !important; }
    }

    .fixed-chat-widget-btn:hover {
        transform: scale(1.15) !important;
        box-shadow: 0 12px 35px rgba(0, 0, 0, 0.35) !important;
        animation-play-state: paused !important;
    }

    .fixed-chat-widget-chat {
        position: fixed !important;
        bottom: 110px !important;
        right: 25px !important;
        width: 380px !important;
        height: 540px !important;
        background: white !important;
        border-radius: 20px !important;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15) !important;
        transition: all 0.3s ease !important;
        z-index: 999999998 !important;
        display: none !important;
        overflow: hidden !important;
        border: 1px solid #e0e0e0 !important;
        flex-direction: column !important;
    }

    .fixed-chat-widget-chat.show {
        display: flex !important;
    }

    .fixed-chat-widget-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        padding: 15px !important;
        text-align: center !important;
        font-weight: bold !important;
        font-size: 16px !important;
        position: relative !important;
        flex-shrink: 0 !important;
        font-family: Arial, sans-serif !important;
    }

    .fixed-chat-widget-close {
        position: absolute !important;
        right: 15px !important;
        top: 50% !important;
        transform: translateY(-50%) !important;
        background: none !important;
        border: none !important;
        color: white !important;
        font-size: 20px !important;
        cursor: pointer !important;
        padding: 5px !important;
        border-radius: 50% !important;
        transition: background 0.2s !important;
        font-family: Arial, sans-serif !important;
        line-height: 1 !important;
    }

    .fixed-chat-widget-close:hover {
        background: rgba(255, 255, 255, 0.2) !important;
    }

    .fixed-chat-widget-messages {
        flex: 1 !important;
        padding: 15px !important;
        overflow-y: auto !important;
        background: #f8f9fa !important;
        scroll-behavior: smooth !important;
        display: flex !important;
        flex-direction: column !important;
        gap: 12px !important;
    }

    .fixed-chat-widget-input {
        display: flex !important;
        padding: 15px !important;
        background: white !important;
        border-top: 1px solid #e9ecef !important;
        flex-shrink: 0 !important;
        gap: 10px !important;
    }

    .fixed-chat-widget-input input {
        flex: 1 !important;
        padding: 12px !important;
        border: 2px solid #e9ecef !important;
        border-radius: 25px !important;
        outline: none !important;
        font-size: 14px !important;
        transition: border-color 0.3s !important;
        max-height: 80px !important;
        resize: none !important;
        font-family: Arial, sans-serif !important;
        box-sizing: border-box !important;
    }

    .fixed-chat-widget-input input:focus {
        border-color: #667eea !important;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
    }

    .fixed-chat-widget-input button {
        padding: 12px 20px !important;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        border: none !important;
        border-radius: 25px !important;
        cursor: pointer !important;
        font-size: 14px !important;
        transition: all 0.3s !important;
        font-weight: 500 !important;
        font-family: Arial, sans-serif !important;
        white-space: nowrap !important;
    }

    .fixed-chat-widget-input button:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3) !important;
    }

    .fixed-chat-widget-input button:disabled {
        background: #ccc !important;
        cursor: not-allowed !important;
        transform: none !important;
        box-shadow: none !important;
    }

    .fixed-chat-widget-message {
        max-width: 80% !important;
        padding: 12px 16px !important;
        border-radius: 18px !important;
        line-height: 1.4 !important;
        font-size: 14px !important;
        word-wrap: break-word !important;
        font-family: Arial, sans-serif !important;
        margin: 0 !important;
    }

    .fixed-chat-widget-message.user {
        background: #e3f2fd !important;
        color: #1976d2 !important;
        margin-left: auto !important;
        border-bottom-right-radius: 4px !important;
        text-align: left !important;
    }

    .fixed-chat-widget-message.ai {
        background: white !important;
        color: #333 !important;
        border-bottom-left-radius: 4px !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
        text-align: left !important;
        align-self: flex-start !important;
    }

    .fixed-chat-widget-quick-reply {
        display: inline-block !important;
        margin: 4px !important;
        padding: 8px 12px !important;
        background: #f8f9fa !important;
        color: #495057 !important;
        border: 1px solid #dee2e6 !important;
        border-radius: 15px !important;
        font-size: 12px !important;
        cursor: pointer !important;
        transition: all 0.2s !important;
        user-select: none !important;
        font-family: Arial, sans-serif !important;
        text-align: center !important;
    }

    .fixed-chat-widget-quick-reply:hover {
        background: #e9ecef !important;
        border-color: #667eea !important;
        color: #667eea !important;
        transform: translateY(-1px) !important;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2) !important;
    }

    .typing-indicator {
        display: flex !important;
        align-items: center !important;
        gap: 5px !important;
        padding: 8px 12px !important;
        color: #6c757d !important;
        font-size: 13px !important;
        background: #f8f9fa !important;
        border-radius: 18px !important;
        align-self: flex-start !important;
        font-family: Arial, sans-serif !important;
    }

    .typing-dots {
        display: flex !important;
        gap: 3px !important;
    }

    .typing-dots span {
        width: 6px !important;
        height: 6px !important;
        background: #6c757d !important;
        border-radius: 50% !important;
        animation: typing 1.4s infinite !important;
        display: inline-block !important;
    }

    @keyframes typing {
        0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
        30% { transform: translateY(-10px); opacity: 1; }
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 768px) {
        .fixed-chat-widget-btn {
            bottom: 20px !important;
            right: 20px !important;
            width: 60px !important;
            height: 60px !important;
            font-size: 24px !important;
        }

        .fixed-chat-widget-chat {
            bottom: 85px !important;
            right: 15px !important;
            width: calc(100vw - 30px) !important;
            height: 60vh !important;
            max-width: 400px !important;
            min-height: 300px !important;
        }

        .fixed-chat-widget-header {
            font-size: 14px !important;
        }

        .fixed-chat-widget-message {
            max-width: 85% !important;
            font-size: 13px !important;
        }
    }

    @media (max-width: 480px) {
        .fixed-chat-widget-chat {
            width: calc(100vw - 20px) !important;
            right: 10px !important;
            bottom: 75px !important;
        }

        .fixed-chat-widget-input {
            padding: 12px !important;
            gap: 8px !important;
        }

        .fixed-chat-widget-input input,
        .fixed-chat-widget-input button {
            font-size: 13px !important;
            padding: 10px 16px !important;
        }
    }

    /* –î–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
    @media (max-height: 400px) {
        .fixed-chat-widget-btn {
            display: none !important;
        }
    }

    /* –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å */
    .fixed-chat-widget-btn {
        pointer-events: auto !important;
        z-index: 999999999 !important;
    }

    .fixed-chat-widget-chat {
        pointer-events: auto !important;
        z-index: 999999998 !important;
    }
</style>

<div class="fixed-chat-widget-btn" id="fixedChatWidgetBtn" title="AI –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –∫–ª—É–±–∞–º" style="pointer-events: auto; z-index: 999999999;">
    ü§ñ
</div>

<div class="fixed-chat-widget-chat" id="fixedChatWidgetChat" style="pointer-events: auto; z-index: 999999998;">
    <div class="fixed-chat-widget-header">
        ü§ñ AI –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –∫–ª—É–±–∞–º
        <button class="fixed-chat-widget-close" id="fixedChatWidgetClose">√ó</button>
    </div>
    <div class="fixed-chat-widget-messages" id="fixedChatWidgetMessages">
        <div class="fixed-chat-widget-message ai">
            <strong>üöÄ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</strong><br>
            –Ø - –≤–∞—à AI –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é —Ñ–∞–Ω-–∫–ª—É–±–æ–≤ –∏ —Å–æ–æ–±—â–µ—Å—Ç–≤.<br><br>
            <em>üí° –ü—Ä–æ—Å—Ç–æ —Å–∫–∞–∂–∏—Ç–µ, –∫–∞–∫–æ–π –∫–ª—É–± –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å:</em><br>
            ‚Ä¢ "–•–æ—á—É —Å–æ–∑–¥–∞—Ç—å —à–∞—Ö–º–∞—Ç–Ω—ã–π –∫–ª—É–±"<br>
            ‚Ä¢ "–ù—É–∂–µ–Ω –∫–ª—É–± –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—é"<br>
            ‚Ä¢ "–ò—â—É —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –∫–ª—É–±"
        </div>
    </div>
    <div class="fixed-chat-widget-input">
        <input type="text" id="fixedChatWidgetInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="500" />
        <button id="fixedChatWidgetSend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
</div>

<script>
    // –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JavaScript –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞
    (function() {
        'use strict';

        class FixedChatWidget {
            constructor() {
                this.isOpen = false;
                this.sessionId = 'main_' + Date.now();
                this.isTyping = false;
                this.initializeElements();
                this.attachEventListeners();
                this.loadQuickReplies();
                console.log('ü§ñ FixedChatWidget: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
            }

            initializeElements() {
                this.btn = document.getElementById('fixedChatWidgetBtn');
                this.chat = document.getElementById('fixedChatWidgetChat');
                this.messages = document.getElementById('fixedChatWidgetMessages');
                this.input = document.getElementById('fixedChatWidgetInput');
                this.sendBtn = document.getElementById('fixedChatWidgetSend');
                this.closeBtn = document.getElementById('fixedChatWidgetClose');
            }

            attachEventListeners() {
                if (this.btn) this.btn.addEventListener('click', () => this.toggleChat());
                if (this.closeBtn) this.closeBtn.addEventListener('click', () => this.toggleChat());
                if (this.sendBtn) this.sendBtn.addEventListener('click', () => this.sendMessage());
                if (this.input) {
                    this.input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            this.sendMessage();
                        }
                    });
                }

                // Quick reply handlers
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('fixed-chat-widget-quick-reply')) {
                        const message = e.target.textContent;
                        if (this.input) {
                            this.input.value = message;
                            this.sendMessage();
                        }
                    }
                });

                // Close on escape
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.isOpen) {
                        this.toggleChat();
                    }
                });
            }

            toggleChat() {
                this.isOpen = !this.isOpen;
                if (this.isOpen) {
                    this.chat.classList.add('show');
                    if (this.input) {
                        this.input.focus();
                        this.loadQuickReplies();
                    }
                    console.log('ü§ñ FixedChatWidget: –ß–∞—Ç –æ—Ç–∫—Ä—ã—Ç');
                } else {
                    this.chat.classList.remove('show');
                    console.log('ü§ñ FixedChatWidget: –ß–∞—Ç –∑–∞–∫—Ä—ã—Ç');
                }
            }

            addTypingIndicator() {
                if (!this.messages) return;
                const typingDiv = document.createElement('div');
                typingDiv.className = 'typing-indicator';
                typingDiv.id = 'typingIndicator';
                typingDiv.innerHTML = `
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    –ü–µ—á–∞—Ç–∞–µ—Ç...
                `;
                this.messages.appendChild(typingDiv);
                this.scrollToBottom();
            }

            removeTypingIndicator() {
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }

            addQuickReplies() {
                if (!this.messages) return;
                const quickReplies = [
                    'üéÆ –°–æ–∑–¥–∞—Ç—å –∏–≥—Ä–æ–≤–æ–π –∫–ª—É–±',
                    'üìö –ö–Ω–∏–∂–Ω—ã–π –∫–ª—É–±',
                    'üç≥ –ö—É–ª–∏–Ω–∞—Ä–Ω—ã–π –∫–ª—É–±',
                    'üì∏ –§–æ—Ç–æ-–∫–ª—É–±',
                    'üéµ –ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π –∫–ª—É–±',
                    'üèÉ –°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –∫–ª—É–±',
                    '‚ùì –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?'
                ];

                quickReplies.forEach(reply => {
                    const replyElement = document.createElement('div');
                    replyElement.className = 'fixed-chat-widget-quick-reply';
                    replyElement.textContent = reply;
                    this.messages.appendChild(replyElement);
                });

                this.scrollToBottom();
            }

            removeQuickReplies() {
                const quickReplies = document.querySelectorAll('.fixed-chat-widget-quick-reply');
                quickReplies.forEach(reply => reply.remove());
            }

            loadQuickReplies() {
                setTimeout(() => {
                    this.addQuickReplies();
                }, 500);
            }

            sendMessage() {
                if (!this.input) return;
                const message = this.input.value.trim();
                if (!message) return;

                this.input.value = '';
                if (this.input) this.input.disabled = true;
                if (this.sendBtn) this.sendBtn.disabled = true;

                // Add user message
                this.addMessage(message, 'user');

                // Remove quick replies after first message
                if (this.messages.children.length > 1) {
                    this.removeQuickReplies();
                }

                // Simulate typing and send to AI
                setTimeout(() => {
                    this.sendToAI(message);
                }, 300);
            }

            addMessage(text, sender) {
                if (!this.messages) return;
                const messageDiv = document.createElement('div');
                messageDiv.className = `fixed-chat-widget-message ${sender}`;

                // Convert newlines
                const formattedText = text.replace(/\n/g, '<br>');
                messageDiv.innerHTML = formattedText;
                this.messages.appendChild(messageDiv);
                this.scrollToBottom();
            }

            async sendToAI(message) {
                this.addTypingIndicator();
                this.isTyping = true;

                try {
                    const response = await fetch('/api/v1/ai/conversational/agent/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message,
                            session_id: this.sessionId
                        })
                    });

                    const result = await response.json();
                    this.removeTypingIndicator();
                    this.isTyping = false;

                    if (result.success) {
                        this.addMessage(result.response, 'ai');

                        // Add quick replies if available
                        if (result.quick_replies && result.quick_replies.length > 0) {
                            result.quick_replies.forEach(reply => {
                                const replyElement = document.createElement('div');
                                replyElement.className = 'fixed-chat-widget-quick-reply';
                                replyElement.textContent = reply;
                                this.messages.appendChild(replyElement);
                            });
                        }

                        // Handle completion
                        if (result.state === 'completed' || result.action === 'close_chat') {
                            setTimeout(() => {
                                this.addMessage('üéâ –û—Ç–ª–∏—á–Ω–æ! –í–∞—à –∫–ª—É–± —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω! –°–ø–∞—Å–∏–±–æ –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ AI –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞! üéä', 'ai');
                                setTimeout(() => this.toggleChat(), 5000);
                            }, 1000);
                        }
                    } else {
                        this.addMessage('üòî –û–π, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫... –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ —Å–∫–∞–∂–∏—Ç–µ "–ø–æ–º–æ—â—å" –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å! ü§ó', 'ai');
                    }

                } catch (error) {
                    this.removeTypingIndicator();
                    this.isTyping = false;
                    console.error('FixedChatWidget Error:', error);
                    this.addMessage('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞!', 'ai');
                }

                if (this.input) this.input.disabled = false;
                if (this.sendBtn) this.sendBtn.disabled = false;
                if (this.input) this.input.focus();
            }

            scrollToBottom() {
                if (this.messages) {
                    this.messages.scrollTop = this.messages.scrollHeight;
                }
            }
        }

        // Initialize widget when DOM is loaded
        function initializeWidget() {
            console.log('ü§ñ FixedChatWidget: DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');
            window.fixedChatWidget = new FixedChatWidget();
            console.log('‚úÖ FixedChatWidget: –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!');
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeWidget);
        } else {
            initializeWidget();
        }

        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                console.log('ü§ñ FixedChatWidget: –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–∫—Ç–∏–≤–Ω–∞');
            }
        });

    })();
</script>