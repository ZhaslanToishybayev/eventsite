{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep Widget Debug</title>
    <style>
        body {
            font-family: monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            margin: 0;
            padding: 20px;
        }
        .debug-output {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-size: 12px;
        }
        .error { color: #f85149; }
        .success { color: #56d364; }
        .warning { color: #faa61a; }
        .info { color: #79c0ff; }
    </style>
</head>
<body>
    <h1>üîç Deep Widget Debug</h1>

    <div class="debug-output" id="debugLog">
        üöÄ –ó–∞–ø—É—Å–∫ –≥–ª—É–±–æ–∫–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...
    </div>

    <!-- –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å JavaScript —Ñ–∞–π–ª -->
    <script>
        let debugLog = document.getElementById('debugLog');
        let log = '';

        function addToLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            log += `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            debugLog.textContent = log;
            debugLog.scrollTop = debugLog.scrollHeight;
        }

        addToLog('–ù–∞—á–∏–Ω–∞–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É...', 'info');

        // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É JavaScript —Ñ–∞–π–ª–∞
        addToLog('1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ JavaScript —Ñ–∞–π–ª–∞', 'info');

        function checkScriptLoading() {
            const scripts = Array.from(document.querySelectorAll('script'));
            const widgetScript = scripts.find(script =>
                script.src && script.src.includes('professional-chat-widget.js')
            );

            if (widgetScript) {
                addToLog(`‚úÖ –ù–∞–π–¥–µ–Ω —Å–∫—Ä–∏–ø—Ç: ${widgetScript.src}`, 'success');
                addToLog(`   –°—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏: ${widgetScript.readyState || 'unknown'}`, 'info');
                addToLog(`   async: ${widgetScript.async}, defer: ${widgetScript.defer}`, 'info');
            } else {
                addToLog('‚ùå –°–∫—Ä–∏–ø—Ç professional-chat-widget.js –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                addToLog('–ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤—Ä—É—á–Ω—É—é...', 'warning');

                // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –≤—Ä—É—á–Ω—É—é
                const script = document.createElement('script');
                script.src = '/static/js/professional-chat-widget.js?v=5.0.0';
                script.onload = function() {
                    addToLog('‚úÖ –°–∫—Ä–∏–ø—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω', 'success');
                    setTimeout(checkWidgetClass, 100);
                };
                script.onerror = function() {
                    addToLog('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞', 'error');
                };
                document.head.appendChild(script);
            }
        }

        // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª–∞—Å—Å–∞
        function checkWidgetClass() {
            addToLog('2. –ü—Ä–æ–≤–µ—Ä–∫–∞ ProfessionalChatWidget –∫–ª–∞—Å—Å–∞', 'info');

            if (typeof ProfessionalChatWidget === 'function') {
                addToLog('‚úÖ ProfessionalChatWidget –∫–ª–∞—Å—Å –Ω–∞–π–¥–µ–Ω', 'success');
                addToLog(`   –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä: ${ProfessionalChatWidget.toString().substring(0, 100)}...`, 'info');
            } else {
                addToLog(`‚ùå ProfessionalChatWidget –∫–ª–∞—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω`, 'error');
                addToLog(`   typeof ProfessionalChatWidget: ${typeof ProfessionalChatWidget}`, 'error');
                addToLog(`   window.ProfessionalChatWidget: ${window.ProfessionalChatWidget}`, 'error');
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –≤–∏–¥–∂–µ—Ç–æ–º
            const widgetVars = Object.keys(window).filter(key =>
                key.toLowerCase().includes('widget') || key.toLowerCase().includes('professional')
            );

            if (widgetVars.length > 0) {
                addToLog('üîç –ù–∞–π–¥–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –≤–∏–¥–∂–µ—Ç–æ–º:', 'info');
                widgetVars.forEach(key => {
                    addToLog(`   ${key}: ${typeof window[key]}`, 'info');
                });
            } else {
                addToLog('‚ö†Ô∏è –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤–∏–¥–∂–µ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'warning');
            }
        }

        // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        function checkDOMElements() {
            addToLog('3. –ü—Ä–æ–≤–µ—Ä–∫–∞ DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤', 'info');

            const widgetBtn = document.getElementById('professionalChatWidgetBtn');
            const widgetChat = document.getElementById('professionalChatWidgetChat');

            if (widgetBtn) {
                addToLog('‚úÖ –ö–Ω–æ–ø–∫–∞ –≤–∏–¥–∂–µ—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞', 'success');
                const styles = getComputedStyle(widgetBtn);
                addToLog(`   Position: ${styles.position}`, 'info');
                addToLog(`   Display: ${styles.display}`, 'info');
                addToLog(`   Visibility: ${styles.visibility}`, 'info');
                addToLog(`   Z-index: ${styles.zIndex}`, 'info');
            } else {
                addToLog('‚ùå –ö–Ω–æ–ø–∫–∞ –≤–∏–¥–∂–µ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
            }

            if (widgetChat) {
                addToLog('‚úÖ –ß–∞—Ç –≤–∏–¥–∂–µ—Ç–∞ –Ω–∞–π–¥–µ–Ω', 'success');
                const styles = getComputedStyle(widgetChat);
                addToLog(`   Position: ${styles.position}`, 'info');
                addToLog(`   Display: ${styles.display}`, 'info');
                addToLog(`   Visibility: ${styles.visibility}`, 'info');
                addToLog(`   Z-index: ${styles.zIndex}`, 'info');
            } else {
                addToLog('‚ùå –ß–∞—Ç –≤–∏–¥–∂–µ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
            }
        }

        // 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º CSS
        function checkCSS() {
            addToLog('4. –ü—Ä–æ–≤–µ—Ä–∫–∞ CSS', 'info');

            const stylesheets = Array.from(document.styleSheets);
            const professionalCSS = stylesheets.find(sheet =>
                sheet.href && sheet.href.includes('professional-chat-widget.css')
            );

            if (professionalCSS) {
                addToLog('‚úÖ Professional CSS –Ω–∞–π–¥–µ–Ω', 'success');
                addToLog(`   URL: ${professionalCSS.href}`, 'info');

                // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ CSS –ø—Ä–∞–≤–∏–ª–∞
                try {
                    const rules = professionalCSS.cssRules || professionalCSS.rules;
                    if (rules && rules.length > 0) {
                        addToLog(`   –ù–∞–π–¥–µ–Ω–æ ${rules.length} CSS –ø—Ä–∞–≤–∏–ª`, 'success');
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∞–≤–∏–ª
                        for (let i = 0; i < Math.min(5, rules.length); i++) {
                            const rule = rules[i];
                            if (rule.selectorText && rule.selectorText.includes('professional')) {
                                addToLog(`   ${rule.selectorText}: ...`, 'info');
                            }
                        }
                    }
                } catch (e) {
                    addToLog(`   ‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ CSS –ø—Ä–∞–≤–∏–ª–∞–º: ${e.message}`, 'error');
                }
            } else {
                addToLog('‚ùå Professional CSS –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                addToLog('–ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å CSS –≤—Ä—É—á–Ω—É—é...', 'warning');

                // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å CSS –≤—Ä—É—á–Ω—É—é
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = '/static/css/professional-chat-widget.css?v=5.0.0';
                link.onload = function() {
                    addToLog('‚úÖ CSS —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω', 'success');
                };
                link.onerror = function() {
                    addToLog('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ CSS', 'error');
                };
                document.head.appendChild(link);
            }
        }

        // 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Å–æ–ª—å –Ω–∞ –æ—à–∏–±–∫–∏
        function checkConsoleErrors() {
            addToLog('5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—à–∏–±–æ–∫ –≤ –∫–æ–Ω—Å–æ–ª–∏', 'info');

            // –≠—Ç–æ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –ø–æ–∫–∞–∂–µ—Ç, —á—Ç–æ –º—ã –ø—ã—Ç–∞–µ–º—Å—è
            addToLog('   üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫', 'info');
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
        setTimeout(() => {
            checkScriptLoading();
            setTimeout(() => {
                checkWidgetClass();
                checkDOMElements();
                checkCSS();
                checkConsoleErrors();
            }, 500);
        }, 100);

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
        window.addEventListener('error', function(e) {
            addToLog(`‚ùå –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞: ${e.message}`, 'error');
        });

        window.addEventListener('unhandledrejection', function(e) {
            addToLog(`‚ùå Unhandled promise rejection: ${e.reason}`, 'error');
        });
    </script>
</body>
</html>