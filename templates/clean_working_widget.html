<!-- –°–ê–ú–´–ô –ü–†–û–°–¢–û–ô –í–ò–î–ñ–ï–¢ –ë–ï–ó –í–ù–ï–®–ù–ò–• –ó–ê–í–ò–°–ò–ú–û–°–¢–ï–ô -->
<style>
    /* –¢–æ–ª—å–∫–æ inline —Å—Ç–∏–ª–∏, –Ω–∏–∫–∞–∫–∏—Ö –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π */
    .clean-widget-btn {
        position: fixed !important;
        bottom: 30px !important;
        right: 30px !important;
        width: 60px !important;
        height: 60px !important;
        border-radius: 50% !important;
        background: #28a745 !important;
        border: none !important;
        color: white !important;
        font-size: 20px !important;
        cursor: pointer !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important;
        transition: all 0.3s ease !important;
        z-index: 99999 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }

    .clean-widget-btn:hover {
        transform: scale(1.1) !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
    }

    .clean-widget-chat {
        position: fixed !important;
        bottom: 100px !important;
        right: 30px !important;
        width: 320px !important;
        height: 400px !important;
        background: white !important;
        border-radius: 8px !important;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
        z-index: 100000 !important;
        display: none !important;
        flex-direction: column !important;
        font-family: Arial, sans-serif !important;
        overflow: hidden !important;
        border: 1px solid #ddd !important;
    }

    .clean-widget-header {
        background: #28a745 !important;
        color: white !important;
        padding: 10px 15px !important;
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        font-weight: bold !important;
        font-size: 14px !important;
    }

    .clean-widget-close {
        background: rgba(255,255,255,0.2) !important;
        border: none !important;
        color: white !important;
        width: 20px !important;
        height: 20px !important;
        border-radius: 50% !important;
        cursor: pointer !important;
        font-size: 10px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }

    .clean-widget-msg-area {
        flex: 1 !important;
        padding: 10px !important;
        overflow-y: auto !important;
        background: #f8f9fa !important;
    }

    .clean-widget-input {
        padding: 10px 15px !important;
        background: white !important;
        border-top: 1px solid #ddd !important;
    }

    .clean-widget-input input {
        width: 100% !important;
        padding: 8px 12px !important;
        border: 1px solid #ddd !important;
        border-radius: 20px !important;
        outline: none !important;
        font-size: 14px !important;
        margin-bottom: 5px !important;
    }

    .clean-widget-input button {
        width: 100% !important;
        padding: 8px !important;
        background: #28a745 !important;
        color: white !important;
        border: none !important;
        border-radius: 15px !important;
        cursor: pointer !important;
        font-size: 14px !important;
        transition: background 0.2s ease !important;
    }

    .clean-widget-input button:hover {
        background: #218838 !important;
    }

    .clean-widget-msg {
        margin: 5px 0 !important;
        max-width: 90% !important;
    }

    .clean-widget-msg.user {
        margin-left: auto !important;
        text-align: right !important;
    }

    .clean-widget-msg.bot {
        margin-right: auto !important;
        text-align: left !important;
    }

    .clean-widget-msg-content {
        padding: 8px 12px !important;
        border-radius: 15px !important;
        font-size: 14px !important;
        display: inline-block !important;
    }

    .clean-widget-msg.user .clean-widget-msg-content {
        background: #28a745 !important;
        color: white !important;
    }

    .clean-widget-msg.bot .clean-widget-msg-content {
        background: #e9ecef !important;
        color: #333 !important;
    }
</style>

<button class="clean-widget-btn" id="cleanWidgetBtn" title="AI –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç">üí¨</button>

<div class="clean-widget-chat" id="cleanWidgetChat">
    <div class="clean-widget-header">
        <span>AI –ü–æ–º–æ—â–Ω–∏–∫</span>
        <button class="clean-widget-close" id="cleanWidgetClose">‚úï</button>
    </div>
    <div class="clean-widget-msg-area" id="cleanWidgetMsgArea">
        <div class="clean-widget-msg bot">
            <div class="clean-widget-msg-content">
                üëã –ü—Ä–∏–≤–µ—Ç! –ì–æ—Ç–æ–≤ –ø–æ–º–æ—á—å —Å —Å–æ–∑–¥–∞–Ω–∏–µ–º —Ñ–∞–Ω-–∫–ª—É–±–∞!
            </div>
        </div>
    </div>
    <div class="clean-widget-input">
        <input type="text" id="cleanWidgetInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="150">
        <button id="cleanWidgetSend">‚û§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
</div>

<script>
    // –ß–∏—Å—Ç—ã–π JavaScript –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    (function() {
        'use strict';

        function openWidget() {
            console.log('‚úÖ –ß–∏—Å—Ç—ã–π –≤–∏–¥–∂–µ—Ç: –û—Ç–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç');
            document.getElementById('cleanWidgetChat').style.display = 'flex';
            setTimeout(() => {
                const input = document.getElementById('cleanWidgetInput');
                if (input) input.focus();
            }, 100);
        }

        function closeWidget() {
            console.log('‚úÖ –ß–∏—Å—Ç—ã–π –≤–∏–¥–∂–µ—Ç: –ó–∞–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç');
            document.getElementById('cleanWidgetChat').style.display = 'none';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendWidgetMessage();
            }
        }

        async function sendWidgetMessage() {
            const input = document.getElementById('cleanWidgetInput');
            const messagesDiv = document.getElementById('cleanWidgetMsgArea');
            const userMessage = input.value.trim();

            if (!userMessage) return;

            console.log('‚úÖ –ß–∏—Å—Ç—ã–π –≤–∏–¥–∂–µ—Ç: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ:', userMessage);

            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            messagesDiv.innerHTML += `
                <div class="clean-widget-msg user">
                    <div class="clean-widget-msg-content">${escapeHtml(userMessage)}</div>
                </div>
            `;

            input.value = '';
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            try {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL –¥–ª—è HTTPS
                const protocol = window.location.protocol;
                const host = window.location.host;
                const apiUrl = `${protocol}//${host}/api/v1/ai/production/agent/`;

                console.log('‚úÖ –ß–∏—Å—Ç—ã–π –≤–∏–¥–∂–µ—Ç: URL API:', apiUrl);

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({
                        message: userMessage,
                        session_id: 'clean_' + Date.now()
                    })
                });

                console.log('‚úÖ –ß–∏—Å—Ç—ã–π –≤–∏–¥–∂–µ—Ç: –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ –ß–∏—Å—Ç—ã–π –≤–∏–¥–∂–µ—Ç: –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã:', data);

                    if (data.success) {
                        const botResponse = data.response || 'ü§ñ –û—Ç–≤–µ—Ç –æ—Ç AI';
                        // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç AI
                        messagesDiv.innerHTML += `
                            <div class="clean-widget-msg bot">
                                <div class="clean-widget-msg-content">${escapeHtml(botResponse)}</div>
                            </div>
                        `;
                    } else {
                        throw new Error(data.error || 'AI error');
                    }
                } else {
                    throw new Error('API error: ' + response.status);
                }
            } catch (error) {
                console.error('‚ùå –ß–∏—Å—Ç—ã–π –≤–∏–¥–∂–µ—Ç: –û—à–∏–±–∫–∞:', error);

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                messagesDiv.innerHTML += `
                    <div class="clean-widget-msg bot">
                        <div class="clean-widget-msg-content">‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.</div>
                    </div>
                `;
            }

            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getCsrfToken() {
            const token = document.querySelector('[name=csrfmiddlewaretoken]');
            if (!token) {
                const meta = document.querySelector('meta[name="csrf-token"]');
                return meta ? meta.getAttribute('content') : '';
            }
            return token.value;
        }

        function initWidget() {
            console.log('‚úÖ –ß–∏—Å—Ç—ã–π –≤–∏–¥–∂–µ—Ç: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è');

            const button = document.getElementById('cleanWidgetBtn');
            const chat = document.getElementById('cleanWidgetChat');
            const closeBtn = document.getElementById('cleanWidgetClose');
            const sendBtn = document.getElementById('cleanWidgetSend');
            const input = document.getElementById('cleanWidgetInput');

            if (!button || !chat) {
                console.error('‚ùå –ß–∏—Å—Ç—ã–π –≤–∏–¥–∂–µ—Ç: –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                return;
            }

            console.log('‚úÖ –ß–∏—Å—Ç—ã–π –≤–∏–¥–∂–µ—Ç: –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã');

            button.onclick = openWidget;
            if (closeBtn) closeBtn.onclick = closeWidget;
            if (sendBtn) sendBtn.onclick = sendWidgetMessage;
            if (input) input.addEventListener('keypress', handleKeyPress);

            console.log('‚úÖ –ß–∏—Å—Ç—ã–π –≤–∏–¥–∂–µ—Ç: –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã');
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initWidget);
        } else {
            initWidget();
        }

        console.log('‚úÖ –ß–∏—Å—Ç—ã–π –≤–∏–¥–∂–µ—Ç: –ó–∞–≥—Ä—É–∂–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
    })();
</script>