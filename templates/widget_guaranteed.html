<!-- –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–û –†–ê–ë–û–¢–ê–Æ–©–ò–ô –í–ò–î–ñ–ï–¢ -->
<style>
    .guaranteed-widget-button {
        position: fixed !important;
        bottom: 30px !important;
        right: 30px !important;
        z-index: 9999 !important;
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        font-size: 32px;
        cursor: pointer;
        box-shadow: 0 12px 35px rgba(102, 126, 234, 0.5);
        transition: all 0.3s ease;
        display: flex !important;
        align-items: center;
        justify-content: center;
        animation: pulse 2s infinite;
    }

    .guaranteed-widget-button:hover {
        transform: scale(1.1) rotate(5deg);
        box-shadow: 0 15px 40px rgba(102, 126, 234, 0.7);
        animation-play-state: paused;
    }

    @keyframes pulse {
        0% { box-shadow: 0 12px 35px rgba(102, 126, 234, 0.5); }
        50% { box-shadow: 0 12px 35px rgba(102, 126, 234, 0.8); transform: scale(1.05); }
        100% { box-shadow: 0 12px 35px rgba(102, 126, 234, 0.5); }
    }

    .guaranteed-widget-chat {
        position: fixed !important;
        bottom: 120px !important;
        right: 30px !important;
        width: 420px !important;
        height: 600px !important;
        background: white !important;
        border-radius: 20px !important;
        box-shadow: 0 20px 50px rgba(0,0,0,0.3) !important;
        z-index: 10000 !important;
        display: none !important;
        flex-direction: column !important;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        overflow: hidden !important;
        border: 1px solid #e1e8ed !important;
    }

    .guaranteed-widget-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        padding: 16px 20px !important;
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        font-weight: 600 !important;
    }

    .guaranteed-widget-close {
        background: rgba(255,255,255,0.2) !important;
        border: none !important;
        color: white !important;
        width: 32px !important;
        height: 32px !important;
        border-radius: 50% !important;
        cursor: pointer !important;
        font-size: 16px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }

    .guaranteed-widget-messages {
        flex: 1 !important;
        padding: 20px !important;
        overflow-y: auto !important;
        background: #f8f9fa !important;
        max-height: 400px !important;
    }

    .guaranteed-widget-input {
        padding: 16px 20px !important;
        background: white !important;
        display: flex !important;
        gap: 12px !important;
        border-top: 1px solid #e1e8ed !important;
    }

    .guaranteed-widget-input input {
        flex: 1 !important;
        padding: 12px 16px !important;
        border: 2px solid #e1e8ed !important;
        border-radius: 25px !important;
        outline: none !important;
        font-size: 14px !important;
        transition: border-color 0.3s ease !important;
    }

    .guaranteed-widget-input input:focus {
        border-color: #667eea !important;
    }

    .guaranteed-widget-input button {
        padding: 12px 24px !important;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        border: none !important;
        border-radius: 20px !important;
        cursor: pointer !important;
        font-size: 14px !important;
        font-weight: 500 !important;
        transition: transform 0.2s ease !important;
    }

    .guaranteed-widget-input button:hover {
        transform: translateY(-2px) !important;
    }

    .guaranteed-widget-message {
        margin-bottom: 16px !important;
        max-width: 80% !important;
    }

    .guaranteed-widget-message.user {
        margin-left: auto !important;
        text-align: right !important;
    }

    .guaranteed-widget-message.assistant {
        margin-right: auto !important;
        text-align: left !important;
    }

    .guaranteed-widget-message-content {
        padding: 12px 16px !important;
        border-radius: 16px !important;
        font-size: 14px !important;
        line-height: 1.4 !important;
    }

    .guaranteed-widget-message.user .guaranteed-widget-message-content {
        background: #667eea !important;
        color: white !important;
    }

    .guaranteed-widget-message.assistant .guaranteed-widget-message-content {
        background: #e9ecef !important;
        color: #495057 !important;
    }
</style>

<button class="guaranteed-widget-button" title="AI –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç">
    ü§ñ
</button>

<div class="guaranteed-widget-chat" id="guaranteedWidget">
    <div class="guaranteed-widget-header">
        <span>ü§ñ AI –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –∫–ª—É–±–∞–º</span>
        <button class="guaranteed-widget-close" onclick="closeGuaranteedWidget()">‚úï</button>
    </div>
    <div class="guaranteed-widget-messages" id="guaranteedMessages">
        <div class="guaranteed-widget-message assistant">
            <div class="guaranteed-widget-message-content">
                üëã –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø AI –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é —Ñ–∞–Ω-–∫–ª—É–±–æ–≤. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?
            </div>
        </div>
    </div>
    <div class="guaranteed-widget-input">
        <input type="text" id="guaranteedInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="handleGuaranteedKeyPress(event)">
        <button onclick="sendGuaranteedMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
</div>

<script>
    // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏–¥–∂–µ—Ç–∞
    document.addEventListener('DOMContentLoaded', function() {
        console.log('‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤–∏–¥–∂–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω!');

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
        const button = document.querySelector('.guaranteed-widget-button');
        const widget = document.getElementById('guaranteedWidget');

        if (button && widget) {
            console.log('‚úÖ –≠–ª–µ–º–µ–Ω—Ç—ã –≤–∏–¥–∂–µ—Ç–∞ –Ω–∞–π–¥–µ–Ω—ã');

            // –ü—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º onclick –Ω–∞–ø—Ä—è–º—É—é
            button.onclick = function() {
                console.log('‚úÖ –ö–Ω–æ–ø–∫–∞ –Ω–∞–∂–∞—Ç–∞, –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤–∏–¥–∂–µ—Ç');
                widget.style.display = 'flex';
                // –§–æ–∫—É—Å –Ω–∞ input —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                setTimeout(() => {
                    const input = document.getElementById('guaranteedInput');
                    if (input) input.focus();
                }, 100);
            };

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
            const closeBtn = widget.querySelector('.guaranteed-widget-close');
            if (closeBtn) {
                closeBtn.onclick = function() {
                    console.log('‚úÖ –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤–∏–¥–∂–µ—Ç');
                    widget.style.display = 'none';
                };
            }

        } else {
            console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç—ã –≤–∏–¥–∂–µ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
        }
    });

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è input
    window.handleGuaranteedKeyPress = function(event) {
        if (event.key === 'Enter') {
            window.sendGuaranteedMessage();
        }
    };

    window.sendGuaranteedMessage = async function() {
        const input = document.getElementById('guaranteedInput');
        const messagesDiv = document.getElementById('guaranteedMessages');
        const userMessage = input.value.trim();

        if (!userMessage) return;

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        messagesDiv.innerHTML += `
            <div class="guaranteed-widget-message user">
                <div class="guaranteed-widget-message-content">${userMessage}</div>
            </div>
        `;

        input.value = '';
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–Ω–∞–±–∏—Ä–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ"
        const typingDiv = document.createElement('div');
        typingDiv.className = 'guaranteed-widget-message assistant';
        typingDiv.innerHTML = '<div class="guaranteed-widget-message-content">ü§ñ –ü–µ—á–∞—Ç–∞–µ—Ç...</div>';
        typingDiv.id = 'guaranteedTyping';
        messagesDiv.appendChild(typingDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API
            const response = await fetch('/api/v1/ai/production/agent/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                },
                body: JSON.stringify({
                    message: userMessage,
                    session_id: 'widget_' + Math.random().toString(36).substr(2, 9)
                })
            });

            // –£–±–∏—Ä–∞–µ–º "–Ω–∞–±–∏—Ä–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ"
            const typingIndicator = document.getElementById('guaranteedTyping');
            if (typingIndicator) {
                typingIndicator.remove();
            }

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    const botResponse = data.response || 'ü§ñ –û—Ç–≤–µ—Ç –æ—Ç AI';

                    // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç AI
                    messagesDiv.innerHTML += `
                        <div class="guaranteed-widget-message assistant">
                            <div class="guaranteed-widget-message-content">${botResponse}</div>
                        </div>
                    `;
                } else {
                    throw new Error(data.error || 'AI error');
                }
            } else {
                throw new Error('API error');
            }
        } catch (error) {
            // –£–±–∏—Ä–∞–µ–º "–Ω–∞–±–∏—Ä–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ"
            const typingIndicator = document.getElementById('guaranteedTyping');
            if (typingIndicator) {
                typingIndicator.remove();
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
            messagesDiv.innerHTML += `
                <div class="guaranteed-widget-message assistant">
                    <div class="guaranteed-widget-message-content">‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</div>
                </div>
            `;
        }

        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    };
</script>