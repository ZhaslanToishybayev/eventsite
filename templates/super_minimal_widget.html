<!-- Ð¡Ð£ÐŸÐ•Ð -ÐœÐ˜ÐÐ˜ÐœÐÐ›Ð˜Ð¡Ð¢Ð˜Ð§ÐÐ«Ð™ Ð’Ð˜Ð”Ð–Ð•Ð¢ -->
<style>
    .super-widget-btn {
        position: fixed !important;
        bottom: 30px !important;
        right: 30px !important;
        width: 50px !important;
        height: 50px !important;
        border-radius: 50% !important;
        background: #dc3545 !important;
        border: none !important;
        color: white !important;
        font-size: 18px !important;
        cursor: pointer !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important;
        transition: all 0.3s ease !important;
        z-index: 999999 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }

    .super-widget-btn:hover {
        transform: scale(1.1) !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
    }

    .super-widget-chat {
        position: fixed !important;
        bottom: 90px !important;
        right: 30px !important;
        width: 280px !important;
        height: 350px !important;
        background: white !important;
        border-radius: 8px !important;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
        z-index: 9999999 !important;
        display: none !important;
        flex-direction: column !important;
        font-family: Arial, sans-serif !important;
        overflow: hidden !important;
        border: 1px solid #ddd !important;
    }

    .super-widget-header {
        background: #dc3545 !important;
        color: white !important;
        padding: 8px 12px !important;
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        font-weight: bold !important;
        font-size: 12px !important;
    }

    .super-widget-close {
        background: rgba(255,255,255,0.2) !important;
        border: none !important;
        color: white !important;
        width: 18px !important;
        height: 18px !important;
        border-radius: 50% !important;
        cursor: pointer !important;
        font-size: 9px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }

    .super-widget-msg-area {
        flex: 1 !important;
        padding: 8px !important;
        overflow-y: auto !important;
        background: #f8f9fa !important;
    }

    .super-widget-input {
        padding: 8px 12px !important;
        background: white !important;
        border-top: 1px solid #ddd !important;
    }

    .super-widget-input input {
        width: 100% !important;
        padding: 6px 10px !important;
        border: 1px solid #ddd !important;
        border-radius: 15px !important;
        outline: none !important;
        font-size: 12px !important;
        margin-bottom: 4px !important;
    }

    .super-widget-input button {
        width: 100% !important;
        padding: 6px !important;
        background: #dc3545 !important;
        color: white !important;
        border: none !important;
        border-radius: 12px !important;
        cursor: pointer !important;
        font-size: 12px !important;
        transition: background 0.2s ease !important;
    }

    .super-widget-input button:hover {
        background: #c82333 !important;
    }

    .super-widget-msg {
        margin: 3px 0 !important;
        max-width: 95% !important;
    }

    .super-widget-msg.user {
        margin-left: auto !important;
        text-align: right !important;
    }

    .super-widget-msg.bot {
        margin-right: auto !important;
        text-align: left !important;
    }

    .super-widget-msg-content {
        padding: 6px 10px !important;
        border-radius: 12px !important;
        font-size: 12px !important;
        display: inline-block !important;
    }

    .super-widget-msg.user .super-widget-msg-content {
        background: #dc3545 !important;
        color: white !important;
    }

    .super-widget-msg.bot .super-widget-msg-content {
        background: #e9ecef !important;
        color: #333 !important;
    }
</style>

<button class="super-widget-btn" id="superWidgetBtn" title="AI ÐšÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ð½Ñ‚">ðŸ”´</button>

<div class="super-widget-chat" id="superWidgetChat">
    <div class="super-widget-header">
        <span>AI</span>
        <button class="super-widget-close" id="superWidgetClose">âœ•</button>
    </div>
    <div class="super-widget-msg-area" id="superWidgetMsgArea">
        <div class="super-widget-msg bot">
            <div class="super-widget-msg-content">
                Ð“Ð¾Ñ‚Ð¾Ð² Ð¿Ð¾Ð¼Ð¾Ñ‡ÑŒ!
            </div>
        </div>
    </div>
    <div class="super-widget-input">
        <input type="text" id="superWidgetInput" placeholder="Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ..." maxlength="100">
        <button id="superWidgetSend">âž¤</button>
    </div>
</div>

<script>
    (function() {
        try {
            function openWidget() {
                document.getElementById('superWidgetChat').style.display = 'flex';
                setTimeout(() => {
                    const input = document.getElementById('superWidgetInput');
                    if (input) input.focus();
                }, 100);
            }

            function closeWidget() {
                document.getElementById('superWidgetChat').style.display = 'none';
            }

            function handleKeyPress(e) {
                if (e.key === 'Enter') {
                    sendMsg();
                }
            }

            async function sendMsg() {
                const input = document.getElementById('superWidgetInput');
                const msgArea = document.getElementById('superWidgetMsgArea');
                const userMsg = input.value.trim();

                if (!userMsg) return;

                msgArea.innerHTML += `
                    <div class="super-widget-msg user">
                        <div class="super-widget-msg-content">${userMsg}</div>
                    </div>
                `;

                input.value = '';
                msgArea.scrollTop = msgArea.scrollHeight;

                try {
                    const protocol = window.location.protocol;
                    const host = window.location.host;
                    const apiUrl = `${protocol}//${host}/api/v1/ai/production/agent/`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        },
                        body: JSON.stringify({
                            message: userMsg,
                            session_id: 'super_' + Date.now()
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const botResponse = data.success ? data.response : 'ÐžÑˆÐ¸Ð±ÐºÐ°';

                        msgArea.innerHTML += `
                            <div class="super-widget-msg bot">
                                <div class="super-widget-msg-content">${botResponse}</div>
                            </div>
                        `;
                    } else {
                        throw new Error('API error');
                    }
                } catch (error) {
                    msgArea.innerHTML += `
                        <div class="super-widget-msg bot">
                            <div class="super-widget-msg-content">ÐžÑˆÐ¸Ð±ÐºÐ°</div>
                        </div>
                    `;
                }

                msgArea.scrollTop = msgArea.scrollHeight;
            }

            function getCsrfToken() {
                const token = document.querySelector('[name=csrfmiddlewaretoken]');
                if (!token) {
                    const meta = document.querySelector('meta[name="csrf-token"]');
                    return meta ? meta.getAttribute('content') : '';
                }
                return token.value;
            }

            function initWidget() {
                document.getElementById('superWidgetBtn').onclick = openWidget;
                document.getElementById('superWidgetClose').onclick = closeWidget;
                document.getElementById('superWidgetSend').onclick = sendMsg;
                document.getElementById('superWidgetInput').addEventListener('keypress', handleKeyPress);
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initWidget);
            } else {
                initWidget();
            }
        } catch (error) {
            console.error('Super widget error:', error);
        }
    })();
</script>