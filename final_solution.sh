#!/bin/bash

# –§–ò–ù–ê–õ–¨–ù–û–ï –†–ê–ë–û–ß–ï–ï –†–ï–®–ï–ù–ò–ï - –ó–∞–ø—É—Å–∫ –Ω–∞ –ø–æ—Ä—Ç—É 80

echo "üöÄ –§–ò–ù–ê–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï - –°–ê–ô–¢ –ù–ê –ü–û–†–¢–£ 80"
echo "=========================================="

cd /var/www/myapp/eventsite

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã..."
pkill -f "python.*manage.py" 2>/dev/null
echo "‚úÖ –í—Å–µ Django –ø—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
source venv/bin/activate
echo "‚úÖ –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º Django
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º Django..."
python manage.py check --deploy 2>/dev/null && echo "‚úÖ Django –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ –ø–æ—Ä—è–¥–∫–µ" || echo "‚ö†Ô∏è  Django –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏"

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º nginx
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º nginx..."
sudo systemctl stop nginx 2>/dev/null
echo "‚úÖ Nginx –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

# –ó–∞–ø—É—Å–∫–∞–µ–º Django —Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É 80 (–ø—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø)
echo "üåê –ó–∞–ø—É—Å–∫–∞–µ–º Django —Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É 80..."
sudo python manage.py runserver 0.0.0.0:80 --insecure &
sleep 5

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å..."
if curl -s http://127.0.0.1/ > /dev/null; then
    echo "‚úÖ –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 80!"
    echo ""
    echo "üåê –¢–µ–ø–µ—Ä—å –æ—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ:"
    echo "   http://fan-club.kz/"
    echo "   –∏–ª–∏ http://77.243.80.110/"
    echo ""
    echo "üîò –ù–∞–π–¥–∏—Ç–µ ü§ñ –∫–Ω–æ–ø–∫—É –≤ –ø—Ä–∞–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É"
    echo "üí¨ –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É - –¥–æ–ª–∂–µ–Ω –æ—Ç–∫—Ä—ã—Ç—å—Å—è AI —á–∞—Ç"
    echo ""
    echo "‚úÖ –í–ò–î–ñ–ï–¢ –î–û–õ–ñ–ï–ù –†–ê–ë–û–¢–ê–¢–¨!"
    echo "–ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞"
    wait
else
    echo "‚ùå –°–∞–π—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 80"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Django —Å–µ—Ä–≤–µ—Ä–∞"
    echo "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é: sudo python manage.py runserver 0.0.0.0:80 --insecure"
fi