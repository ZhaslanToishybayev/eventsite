"""
ðŸš¦ Agent Router
Routes user messages to the appropriate specialist agent.
"""

import json
from typing import Dict, Any, List, Optional
from django.conf import settings
from .registry import AgentRegistry
from .base import BaseAgent

class AgentRouter:
    """
    Analyzes user intent and routes to the best available agent.
    """
    
    def __init__(self, openai_service):
        self.openai_service = openai_service
        self.system_prompt = """Ð¢Ñ‹ - Ð¸Ð½Ñ‚ÐµÐ»Ð»ÐµÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð¸Ð·Ð°Ñ‚Ð¾Ñ€ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ñ‹ "Ð¦Ð•ÐÐ¢Ð  Ð¡ÐžÐ‘Ð«Ð¢Ð˜Ð™".

ðŸŽ¯ Ð¢Ð’ÐžÐ¯ Ð—ÐÐ”ÐÐ§Ð:
ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ, ÐºÐ°ÐºÐ¾Ð¹ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»Ð¸ÑÑ‚ Ð»ÑƒÑ‡ÑˆÐµ Ð²ÑÐµÐ³Ð¾ Ð¿Ð¾Ð´Ñ…Ð¾Ð´Ð¸Ñ‚ Ð´Ð»Ñ Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð½Ð° Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ.

ðŸ‘¥ Ð”ÐžÐ¡Ð¢Ð£ÐŸÐÐ«Ð• Ð¡ÐŸÐ•Ð¦Ð˜ÐÐ›Ð˜Ð¡Ð¢Ð«:

1ï¸âƒ£ **orchestrator** - ÐžÐ±Ñ‰Ð¸Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹, Ð¿Ñ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ñ, Ð½Ð°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ñ
   ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹:
   - "ÐŸÑ€Ð¸Ð²ÐµÑ‚", "Ð—Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹"
   - "Ð§Ñ‚Ð¾ Ñ‚Ñ‹ ÑƒÐ¼ÐµÐµÑˆÑŒ?"
   - "Ð Ð°ÑÑÐºÐ°Ð¶Ð¸ Ð¾ Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ðµ"
   - "Ð§Ñ‚Ð¾ Ñ‚Ð°ÐºÐ¾Ðµ Ð¦ÐµÐ½Ñ‚Ñ€ Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ð¹?"

2ï¸âƒ£ **club_specialist** - ÐŸÐ¾Ð¸ÑÐº ÑÐ¾Ð¾Ð±Ñ‰ÐµÑÑ‚Ð², Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸, Ð¡ÐžÐ—Ð”ÐÐÐ˜Ð• ÐšÐ›Ð£Ð‘ÐžÐ’
   âš ï¸ Ð’ÐÐ–ÐÐž: Ð­Ñ‚Ð¾Ñ‚ Ð°Ð³ÐµÐ½Ñ‚ Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ð”Ð’Ð Ñ‚Ð¸Ð¿Ð° Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²:
   
   Ð) ÐŸÐžÐ˜Ð¡Ðš ÐºÐ»ÑƒÐ±Ð¾Ð² (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ search_clubs):
   - "ÐÐ°Ð¹Ð´Ð¸ ÐºÐ»ÑƒÐ± Ð¿Ð¾ ÑˆÐ°Ñ…Ð¼Ð°Ñ‚Ð°Ð¼"
   - "Ð¥Ð¾Ñ‡Ñƒ Ð¿Ñ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½Ð¸Ñ‚ÑŒÑÑ Ðº ÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ð²Ð½Ð¾Ð¼Ñƒ ÐºÐ»ÑƒÐ±Ñƒ"
   - "ÐŸÐ¾ÐºÐ°Ð¶Ð¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÑÑ‚Ð²Ð° Ð¿Ð¾ Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÑŽ"
   - "ÐšÐ°ÐºÐ¸Ðµ ÐµÑÑ‚ÑŒ Ñ‚Ð²Ð¾Ñ€Ñ‡ÐµÑÐºÐ¸Ðµ ÑÑ‚ÑƒÐ´Ð¸Ð¸?"
   - "ÐšÐ°ÐºÐ¸Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÑÑ‚Ð²Ð° Ñƒ Ð²Ð°Ñ ÐµÑÑ‚ÑŒ?"
   - "Ð˜Ñ‰Ñƒ ÐµÐ´Ð¸Ð½Ð¾Ð¼Ñ‹ÑˆÐ»ÐµÐ½Ð½Ð¸ÐºÐ¾Ð²"
   
   Ð‘) Ð¡ÐžÐ—Ð”ÐÐÐ˜Ð• ÐºÐ»ÑƒÐ±Ð¾Ð² (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ create_club):
   - "Ð¡Ð¾Ð·Ð´Ð°Ð¹ ÐºÐ»ÑƒÐ±"
   - "Ð¥Ð¾Ñ‡Ñƒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ ÐºÐ»ÑƒÐ±"
   - "Ð¥Ð¾Ñ‡Ñƒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÑÑ‚Ð²Ð¾"
   - "ÐŸÐ¾Ð¼Ð¾Ð³Ð¸ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ ÐºÐ»ÑƒÐ±"
   - "Ð¯ Ð½Ðµ Ð¸Ñ‰Ñƒ ÐºÐ»ÑƒÐ±, Ñ Ñ…Ð¾Ñ‡Ñƒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ"
   - "ÐÐµ Ð¸Ñ‰Ñƒ ÐºÐ»ÑƒÐ±, Ñ…Ð¾Ñ‡Ñƒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ"
   - "Ð¡Ð¿Ð¾Ñ€Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ ÐºÐ»ÑƒÐ±" (ÐµÑÐ»Ð¸ Ð¾Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÑ‚ Ð´ÐµÑ‚Ð°Ð»Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ)
   - "ÐžÐ½Ð»Ð°Ð¹Ð½ ÐºÐ»ÑƒÐ±" (ÐµÑÐ»Ð¸ Ð¾Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÑ‚ Ð´ÐµÑ‚Ð°Ð»Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ)
   - "ÐšÐ»ÑƒÐ± Ñ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÐ°Ð¼Ð¸" (ÐµÑÐ»Ð¸ Ð¾Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÑ‚ Ð´ÐµÑ‚Ð°Ð»Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ)
   - Ð›Ð®Ð‘Ð«Ð• Ñ„Ñ€Ð°Ð·Ñ‹, Ð¾Ð¿Ð¸ÑÑ‹Ð²Ð°ÑŽÑ‰Ð¸Ðµ Ð´ÐµÑ‚Ð°Ð»Ð¸ Ð±ÑƒÐ´ÑƒÑ‰ÐµÐ³Ð¾ ÐºÐ»ÑƒÐ±Ð° (Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ, Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ, Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚)
   - "Ð”Ð°Ð²Ð°Ð¹ ÑÐ¾Ð·Ð´Ð°Ð´Ð¸Ð¼ ÐºÐ»ÑƒÐ±"
   - Ð›Ð®Ð‘Ð«Ð• Ñ„Ñ€Ð°Ð·Ñ‹ Ð¿Ñ€Ð¾ Ð¡ÐžÐ—Ð”ÐÐÐ˜Ð•/Ð¡ÐžÐ—Ð”ÐÐ¢Ð¬ ÐºÐ»ÑƒÐ± â†’ club_specialist

3ï¸âƒ£ **support_specialist** - Ð¢ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°, Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒ, Ð˜ÐÐ¡Ð¢Ð Ð£ÐšÐ¦Ð˜Ð˜
   ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹:
   - "ÐšÐ°Ðº ÑÐ±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ?"
   - "ÐÐµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð²Ñ…Ð¾Ð´"
   - "ÐšÐ°Ðº ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ ÐºÐ»ÑƒÐ±?" (Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ, Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ)
   - "ÐšÐ°Ðº Ð²ÑÑ‚ÑƒÐ¿Ð¸Ñ‚ÑŒ Ð² ÑÐ¾Ð¾Ð±Ñ‰ÐµÑÑ‚Ð²Ð¾?"
   - "ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð° Ñ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸ÐµÐ¹"

4ï¸âƒ£ **mentor_specialist** - Ð Ð°Ð·Ð²Ð¸Ñ‚Ð¸Ðµ Ð½Ð°Ð²Ñ‹ÐºÐ¾Ð², Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ðµ, ÐºÐ°Ñ€ÑŒÐµÑ€Ð°
   ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹:
   - "Ð¥Ð¾Ñ‡Ñƒ Ð½Ð°ÑƒÑ‡Ð¸Ñ‚ÑŒÑÑ Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÑŽ"
   - "ÐšÐ°ÐºÐ¸Ðµ ÐºÑƒÑ€ÑÑ‹ ÐµÑÑ‚ÑŒ?"
   - "ÐšÐ°Ðº Ñ€Ð°Ð·Ð²Ð¸Ð²Ð°Ñ‚ÑŒÑÑ Ð² Ð´Ð¸Ð·Ð°Ð¹Ð½Ðµ?"
   - "ÐœÐ¾Ð¹ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑ"
   - "Ð¥Ð¾Ñ‡Ñƒ Ñ€Ð°ÑÑ‚Ð¸ Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾"

ðŸ“‹ ÐŸÐ ÐÐ’Ð˜Ð›Ð ÐœÐÐ Ð¨Ð Ð£Ð¢Ð˜Ð—ÐÐ¦Ð˜Ð˜:

ðŸš¨ ÐšÐ Ð˜Ð¢Ð˜Ð§ÐÐž - Ð ÐÐ¡ÐŸÐžÐ—ÐÐÐ’ÐÐ™ ÐÐÐœÐ•Ð Ð•ÐÐ˜Ð• Ð¡ÐžÐ—Ð”ÐÐ¢Ð¬:
Ð•ÑÐ»Ð¸ Ð² ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸ ÐµÑÑ‚ÑŒ ÑÐ»Ð¾Ð²Ð° "ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ", "ÑÐ¾Ð·Ð´Ð°Ð¹", "Ñ…Ð¾Ñ‡Ñƒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ", "Ð½Ðµ Ð¸Ñ‰Ñƒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ":
â†’ Ð’Ð¡Ð•Ð“Ð”Ð club_specialist (Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ ÑÐ»Ð¾Ð²Ð¾ "Ð¸Ñ‰Ñƒ")

âœ… Ð•ÑÐ»Ð¸ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð¾ Ð¡ÐžÐ—Ð”ÐÐÐ˜Ð˜ ÐšÐ›Ð£Ð‘Ð â†’ club_specialist
   - "Ð¥Ð¾Ñ‡Ñƒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ ÐºÐ»ÑƒÐ±"
   - "Ð¡Ð¾Ð·Ð´Ð°Ð¹ ÐºÐ»ÑƒÐ±"
   - "Ð¯ Ð½Ðµ Ð¸Ñ‰Ñƒ ÐºÐ»ÑƒÐ± Ñ Ñ…Ð¾Ñ‡Ñƒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ"
   - "ÐŸÐ¾Ð¼Ð¾Ð³Ð¸ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÑÑ‚Ð²Ð¾"
   
âœ… Ð•ÑÐ»Ð¸ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð¾ ÐŸÐžÐ˜Ð¡ÐšÐ•/Ð¡ÐžÐžÐ‘Ð©Ð•Ð¡Ð¢Ð’ÐÐ¥/ÐšÐ›Ð£Ð‘ÐÐ¥ â†’ club_specialist
   - "ÐÐ°Ð¹Ð´Ð¸ ÐºÐ»ÑƒÐ±"
   - "ÐšÐ°ÐºÐ¸Ðµ ÐºÐ»ÑƒÐ±Ñ‹ ÐµÑÑ‚ÑŒ?"
   - "Ð˜Ñ‰Ñƒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÑÑ‚Ð²Ð¾"

ðŸŽ¯ ÐšÐ›Ð®Ð§Ð•Ð’ÐžÐ• ÐŸÐ ÐÐ’Ð˜Ð›Ðž: Ð•Ð¡Ð›Ð˜ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¾Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÑ‚ Ð´ÐµÑ‚Ð°Ð»Ð¸ Ð±ÑƒÐ´ÑƒÑ‰ÐµÐ³Ð¾ ÐºÐ»ÑƒÐ±Ð° (Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ, Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ, Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚) â†’ club_specialist
   - "Ð¡Ð¿Ð¾Ñ€Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ð¾Ð½Ð»Ð°Ð¹Ð½ ÐºÐ»ÑƒÐ±"
   - "ÐšÐ»ÑƒÐ± Ñ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÐ°Ð¼Ð¸"
   - "IT ÑÐ¾Ð¾Ð±Ñ‰ÐµÑÑ‚Ð²Ð¾"

âœ… Ð•ÑÐ»Ð¸ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð¾ ÐŸÐ ÐžÐ‘Ð›Ð•ÐœÐÐ¥/ÐŸÐžÐœÐžÐ©Ð˜/ÐšÐÐš Ð¡Ð”Ð•Ð›ÐÐ¢Ð¬ (Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸) â†’ support_specialist
âœ… Ð•ÑÐ»Ð¸ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð¾ Ð ÐÐ—Ð’Ð˜Ð¢Ð˜Ð˜/ÐžÐ‘Ð£Ð§Ð•ÐÐ˜Ð˜/ÐÐÐ’Ð«ÐšÐÐ¥ â†’ mentor_specialist
âœ… Ð•ÑÐ»Ð¸ ÐŸÐ Ð˜Ð’Ð•Ð¢Ð¡Ð¢Ð’Ð˜Ð•/ÐžÐ‘Ð©Ð˜Ð™ Ð’ÐžÐŸÐ ÐžÐ¡ â†’ orchestrator
âœ… Ð•ÑÐ»Ð¸ Ð¡ÐžÐœÐÐ•Ð’ÐÐ•Ð¨Ð¬Ð¡Ð¯ â†’ orchestrator

ðŸŽ¯ Ð¤ÐžÐ ÐœÐÐ¢ ÐžÐ¢Ð’Ð•Ð¢Ð (JSON):
{
    "agent": "agent_name",
    "reason": "ÐºÑ€Ð°Ñ‚ÐºÐ¾Ðµ Ð¾Ð±ÑŠÑÑÐ½ÐµÐ½Ð¸Ðµ"
}

ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹:
- "ÐŸÑ€Ð¸Ð²ÐµÑ‚!" â†’ {"agent": "orchestrator", "reason": "Ð¿Ñ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ"}
- "ÐÐ°Ð¹Ð´Ð¸ ÐºÐ»ÑƒÐ± Ð¿Ð¾ Ñ‚Ð°Ð½Ñ†Ð°Ð¼" â†’ {"agent": "club_specialist", "reason": "Ð¿Ð¾Ð¸ÑÐº ÐºÐ»ÑƒÐ±Ð°"}
- "ÐšÐ°Ðº Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ?" â†’ {"agent": "support_specialist", "reason": "Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒ"}
- "Ð¥Ð¾Ñ‡Ñƒ Ð¸Ð·ÑƒÑ‡Ð°Ñ‚ÑŒ Python" â†’ {"agent": "mentor_specialist", "reason": "Ñ€Ð°Ð·Ð²Ð¸Ñ‚Ð¸Ðµ Ð½Ð°Ð²Ñ‹ÐºÐ¾Ð²"}
"""

    def route(self, message: str, history: List[Dict]) -> str:
        """
        Decides which agent should handle the message.
        Returns the name of the agent.
        """
        try:
            # Prepare context for routing
            messages = [
                {"role": "system", "content": self.system_prompt},
                {"role": "user", "content": f"User message: {message}"}
            ]
            
            # Call OpenAI to decide (using JSON mode if available, or just parsing)
            response = self.openai_service.chat_completion(
                messages,
                response_format={"type": "json_object"}
            )
            
            content = response.get('content', '{}')
            decision = json.loads(content)
            
            agent_name = decision.get('agent', 'orchestrator')
            
            # Verify agent exists
            if not AgentRegistry.get_agent(agent_name):
                return 'orchestrator'
                
            return agent_name
            
        except Exception as e:
            # Fallback to orchestrator on error
            return 'orchestrator'
