#!/usr/bin/env python3
"""
ü§ñ Enhanced Production AI Agent for UnitySphere
–£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å better –ª–æ–≥–∏–∫–æ–π –∏ –∫–∞—á–µ—Å—Ç–≤–æ–º –æ—Ç–≤–µ—Ç–æ–≤
"""

import json
from datetime import datetime
from typing import Dict, List, Optional, Any
import re


class EnhancedAIConsultant:
    """ü§ñ –£–ª—É—á—à–µ–Ω–Ω—ã–π AI –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –¥–ª—è production"""

    def __init__(self):
        self.conversation_state = "greeting"
        self.collected_data = {}
        self.conversation_history = []
        self.user_preferences = {}

    def process_message(self, message: str, session_id: str, history: List[Dict] = None) -> Dict[str, Any]:
        """ü§ñ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —É—á–µ—Ç–æ–º –∏—Å—Ç–æ—Ä–∏–∏"""

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
        if history:
            self.conversation_history = history[-10:]  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é 10 —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏

        message = message.strip()
        original_message = message
        message_lower = message.lower()

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤—ã—Ö–æ–¥ –∏–∑ –¥–∏–∞–ª–æ–≥–∞
        if self._is_goodbye(message_lower):
            return self._handle_goodbye()

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–±—Ä–æ—Å –¥–∏–∞–ª–æ–≥–∞
        if self._is_reset(message_lower):
            return self._handle_reset()

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ–º–æ—â—å
        if self._is_help_request(message_lower):
            return self._handle_help()

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–ª—É–±—ã
        if self._is_club_search(message_lower):
            return self._handle_club_search(message_lower)

        # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
        if self.conversation_state == "greeting":
            return self._handle_greeting(message_lower, original_message)

        # –í—ã–±–æ—Ä —Ç–∏–ø–∞ –∫–ª—É–±–∞
        elif self.conversation_state == "club_type":
            return self._handle_club_type(message_lower, original_message)

        # –ü—Ä–∏–¥—É–º—ã–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ
        elif self.conversation_state == "name_creation":
            return self._handle_name_creation(message_lower, original_message)

        # –û–ø–∏—Å–∞–Ω–∏–µ –∫–ª—É–±–∞
        elif self.conversation_state == "description":
            return self._handle_description(message_lower, original_message)

        # –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        elif self.conversation_state == "contacts":
            return self._handle_contacts(message_lower, original_message)

        # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        elif self.conversation_state == "review":
            return self._handle_review(message_lower, original_message)

        # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è
        elif self.conversation_state == "confirmation":
            return self._handle_confirmation(message_lower, original_message)

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
        elif self.conversation_state == "general_questions":
            return self._handle_general_questions(message_lower, original_message)

        else:
            return self._get_default_response()

    def _is_goodbye(self, message: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–æ—â–∞–Ω–∏–µ"""
        goodbye_words = ["–ø–æ–∫–∞", "–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è", "–ø—Ä–æ—â–∞–π", "bye", "goodbye", "exit", "–≤—ã–π—Ç–∏"]
        return any(word in message for word in goodbye_words)

    def _is_reset(self, message: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–±—Ä–æ—Å –¥–∏–∞–ª–æ–≥–∞"""
        reset_words = ["—Å–±—Ä–æ—Å", "–Ω–∞—á–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞", "reset", "restart", "–∑–∞–Ω–æ–≤–æ"]
        return any(word in message for word in reset_words)

    def _is_help_request(self, message: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∑–∞–ø—Ä–æ—Å –ø–æ–º–æ—â–∏"""
        help_words = ["–ø–æ–º–æ—â—å", "help", "–ø–æ–º–æ–≥–∏", "—Å–ø—Ä–∞–≤–∫–∞", "–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è"]
        return any(word in message for word in help_words)

    def _is_club_search(self, message: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ–∏—Å–∫ –∫–ª—É–±–æ–≤"""
        search_words = ["–Ω–∞–π—Ç–∏", "–ø–æ–∏—Å–∫", "–ø–æ–∏—â–∏", "–Ω–∞–π–¥–∏", "–ø–æ–∫–∞–∑–∞—Ç—å", "–∫–∞–∫–∏–µ –µ—Å—Ç—å", "–µ—Å—Ç—å –ª–∏"]
        club_indicators = ["–∫–ª—É–±", "—Å–æ–æ–±—â–µ—Å—Ç–≤–æ", "—Ñ–∞–Ω-–∫–ª—É–±", "–≥—Ä—É–ø–ø–∞"]
        return any(word in message for word in search_words) and any(word in message for word in club_indicators)

    def _handle_goodbye(self) -> Dict[str, Any]:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ—â–∞–Ω–∏—è"""
        response = """üëã –ë—ã–ª —Ä–∞–¥ –ø–æ–º–æ—á—å!

–ï—Å–ª–∏ –∑–∞—Ö–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å –µ—â–µ –æ–¥–∏–Ω –∫–ª—É–± –∏–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –ø–æ–º–æ—â—å - –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ. –£–¥–∞—á–∏ –≤ —Å–æ–∑–¥–∞–Ω–∏–∏ –≤–∞—à–µ–≥–æ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞! üöÄ

–î–æ –Ω–æ–≤—ã—Ö –≤—Å—Ç—Ä–µ—á! ‚ú®"""
        self.conversation_state = "greeting"
        self.collected_data = {}
        return {"response": response, "state": self.conversation_state}

    def _handle_reset(self) -> Dict[str, Any]:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–±—Ä–æ—Å–∞ –¥–∏–∞–ª–æ–≥–∞"""
        response = """üîÑ –î–∏–∞–ª–æ–≥ —Å–±—Ä–æ—à–µ–Ω.

–î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω–µ–º —Å–Ω–∞—á–∞–ª–∞! üí´

üëã –ü—Ä–∏–≤–µ—Ç! –Ø - AI –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç UnitySphere.
–ü–æ–º–æ–≥—É —Å–æ–∑–¥–∞—Ç—å –≤–∞—à –∫–ª—É–± —á–µ—Ä–µ–∑ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –¥–∏–∞–ª–æ–≥.

üí° –ù–∞–ø—Ä–∏–º–µ—Ä, –≤—ã –º–æ–∂–µ—Ç–µ —Å–∫–∞–∑–∞—Ç—å:
‚Ä¢ "–•–æ—á—É —Å–æ–∑–¥–∞—Ç—å –∫–ª—É–± –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è"
‚Ä¢ "–ù—É–∂–µ–Ω —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –∫–ª—É–±"
‚Ä¢ "–ò—â—É —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –∫–ª—É–±"

–ö–∞–∫–æ–π –∫–ª—É–± –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å?"""
        self.conversation_state = "greeting"
        self.collected_data = {}
        return {
            "response": response,
            "state": self.conversation_state,
            "quick_replies": [
                "–ö–ª—É–± –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è",
                "–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –∫–ª—É–±",
                "–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –∫–ª—É–±",
                "–Ø–∑—ã–∫–æ–≤–æ–π –∫–ª—É–±"
            ]
        }

    def _handle_help(self) -> Dict[str, Any]:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–º–æ—â–∏"""
        response = """üÜò –ü–æ–º–æ—â—å –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é AI –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞:

**–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:**
‚Ä¢ –ù–∞—á–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞: "—Å–±—Ä–æ—Å", "–∑–∞–Ω–æ–≤–æ", "reset"
‚Ä¢ –°–ø—Ä–∞–≤–∫–∞: "–ø–æ–º–æ—â—å", "help", "—Å–ø—Ä–∞–≤–∫–∞"
‚Ä¢ –ü–æ–∫–∞: "–ø–æ–∫–∞", "–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è", "–≤—ã—Ö–æ–¥"

**–ü—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—É–±–∞:**
1. üè∑Ô∏è –í—ã–±–æ—Ä —Ç–∏–ø–∞ –∫–ª—É–±–∞
2. üìù –ü—Ä–∏–¥—É–º—ã–≤–∞–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è
3. üìñ –°–æ–∑–¥–∞–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è
4. üìû –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
5. ‚úÖ –§–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ

**–ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤:**
‚Ä¢ "–•–æ—á—É —Å–æ–∑–¥–∞—Ç—å –∫–ª—É–± –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è"
‚Ä¢ "–ù—É–∂–µ–Ω –∫–ª—É–± –ø–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏"
‚Ä¢ "–°–æ–∑–¥–∞–π —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –∫–ª—É–±"

–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å?"""
        return {
            "response": response,
            "state": self.conversation_state,
            "quick_replies": [
                "–°–æ–∑–¥–∞—Ç—å –∫–ª—É–±",
                "–ù–∞–π—Ç–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–ª—É–±—ã",
                "–°–ø—Ä–∞–≤–∫–∞",
                "–í—ã–π—Ç–∏"
            ]
        }

    def _handle_club_search(self, message: str) -> Dict[str, Any]:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–∏—Å–∫–∞ –∫–ª—É–±–æ–≤"""
        # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø–æ–∏—Å–∫–∞ –ø–æ —Ä–µ–∞–ª—å–Ω–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        # –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫–∏ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏

        tech_clubs = [
            "üî• Python —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ - 25 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤",
            "üéÆ GameDev —Å—Ç—É–¥–∏—è - 18 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤",
            "üåê –í–µ–±-–¥–∏–∑–∞–π–Ω –º–∞—Å—Ç–µ—Ä—Å–∫–∞—è - 32 —É—á–∞—Å—Ç–Ω–∏–∫–∞"
        ]

        creative_clubs = [
            "üé® –¶–∏—Ñ—Ä–æ–≤–æ–µ –∏—Å–∫—É—Å—Å—Ç–≤–æ - 45 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤",
            "üì∏ –§–æ—Ç–æ–≥—Ä–∞—Ñ—ã –≥–æ—Ä–æ–¥–∞ - 67 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤",
            "‚úçÔ∏è –ü–∏—Å–∞—Ç–µ–ª—å—Å–∫–∞—è –º–∞—Å—Ç–µ—Ä—Å–∫–∞—è - 23 —É—á–∞—Å—Ç–Ω–∏–∫–∞"
        ]

        sports_clubs = [
            "‚öΩ –§—É—Ç–±–æ–ª—å–Ω—ã–µ —ç–Ω—Ç—É–∑–∏–∞—Å—Ç—ã - 15 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤",
            "üßò‚Äç‚ôÇÔ∏è –ô–æ–≥–∞ –¥–ª—è –≤—Å–µ—Ö - 34 —É—á–∞—Å—Ç–Ω–∏–∫–∞",
            "üö¥ –í–µ–ª–æ—Å–∏–ø–µ–¥–Ω—ã–µ –ø—Ä–æ–≥—É–ª–∫–∏ - 28 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"
        ]

        response = """üîç –í–æ—Ç –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∏–∑ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∫–ª—É–±–æ–≤ –Ω–∞ UnitySphere:

**üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:**
{}
**üé® –¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ:**
{}
**üèÉ‚Äç‚ôÇÔ∏è –°–ø–æ—Ä—Ç:**
{}

üí° –ß—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –ø–æ—Ö–æ–∂–∏–π –∫–ª—É–± –∏–ª–∏ –Ω–∞–π—Ç–∏ –±–æ–ª—å—à–µ - –Ω–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ!

–•–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å —Å–≤–æ–π –∫–ª—É–±? üôÇ"""
        response = response.format(
            "\n".join(f"‚Ä¢ {club}" for club in tech_clubs),
            "\n".join(f"‚Ä¢ {club}" for club in creative_clubs),
            "\n".join(f"‚Ä¢ {club}" for club in sports_clubs)
        )

        self.conversation_state = "general_questions"
        return {
            "response": response,
            "state": self.conversation_state,
            "quick_replies": [
                "–°–æ–∑–¥–∞—Ç—å –ø–æ—Ö–æ–∂–∏–π –∫–ª—É–±",
                "–î—Ä—É–≥–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏",
                "–ù–∞—á–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ",
                "–°–ø—Ä–∞–≤–∫–∞"
            ]
        }

    def _handle_greeting(self, message: str, original_message: str) -> Dict[str, Any]:
        """üëã –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–æ–π"""
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –Ω–∞–º–µ—Ä–µ–Ω–∏–π
        if self._contains_club_intent(message):
            club_type = self._extract_club_type(message)
            if club_type:
                response = f"""üëã –û—Ç–ª–∏—á–Ω–æ! –í—ã —Ö–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å {club_type} –∫–ª—É–±.

–Ø –ø–æ–º–æ–≥—É —Å–¥–µ–ª–∞—Ç—å —ç—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ –∏ —É–¥–æ–±–Ω–æ! üöÄ

üìä –ù–∞ –Ω–∞—à–µ–º —Å–∞–π—Ç–µ —É–∂–µ –µ—Å—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–æ–±—â–µ—Å—Ç–≤:
‚Ä¢ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏: 156 –∫–ª—É–±–æ–≤
‚Ä¢ –¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ: 98 –∫–ª—É–±–æ–≤
‚Ä¢ –°–ø–æ—Ä—Ç: 87 –∫–ª—É–±–æ–≤
‚Ä¢ –ë–∏–∑–Ω–µ—Å: 65 –∫–ª—É–±–æ–≤
‚Ä¢ –Ø–∑—ã–∫–∏: 45 –∫–ª—É–±–æ–≤

–î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ! üí´

**–®–∞–≥ 1: –ù–∞–∑–≤–∞–Ω–∏–µ**
–ü—Ä–∏–¥—É–º–∞–π—Ç–µ —è—Ä–∫–æ–µ –∏ –∑–∞–ø–æ–º–∏–Ω–∞—é—â–µ–µ—Å—è –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –≤–∞—à–µ–≥–æ "{club_type}" –∫–ª—É–±–∞.

–ö–∞–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤—ã –±—ã –ø—Ä–µ–¥–ª–æ–∂–∏–ª–∏?"""
                self.collected_data['club_type'] = club_type
                self.conversation_state = "name_creation"
            else:
                response = self._get_default_greeting()
                self.conversation_state = "club_type"
        else:
            response = self._get_default_greeting()
            self.conversation_state = "club_type"

        return {
            "response": response,
            "state": self.conversation_state,
            "quick_replies": [
                "–ö–ª—É–± –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è",
                "–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –∫–ª—É–±",
                "–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –∫–ª—É–±",
                "–¢–≤–æ—Ä—á–µ—Å–∫–∏–π –∫–ª—É–±"
            ]
        }

    def _contains_club_intent(self, message: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è —Å–æ–∑–¥–∞—Ç—å –∫–ª—É–±"""
        intent_words = ["—Å–æ–∑–¥–∞—Ç—å", "—Å–¥–µ–ª–∞—Ç—å", "—Ö–æ—á—É", "–Ω—É–∂–µ–Ω", "–Ω–∞–¥–æ", "–±—É–¥—É", "—Å–¥–µ–ª–∞—é"]
        club_indicators = ["–∫–ª—É–±", "—Å–æ–æ–±—â–µ—Å—Ç–≤–æ", "–≥—Ä—É–ø–ø–∞", "—Ñ–∞–Ω-–∫–ª—É–±"]
        return (any(word in message for word in intent_words) and
                any(word in message for word in club_indicators))

    def _extract_club_type(self, message: str) -> Optional[str]:
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–∏–ø–∞ –∫–ª—É–±–∞ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è"""
        club_types = {
            "–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ": ["–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ", "–∫–æ–¥–∏–Ω–≥", "—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞", "–ø—Ä–æ–≥—Ä–∞–º–º—ã", "code", "dev", "coding"],
            "—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è": ["—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è", "—Ñ–æ—Ç–æ", "—Å—ä–µ–º–∫–∞", "camera", "photo", "—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ"],
            "—Å–ø–æ—Ä—Ç": ["—Å–ø–æ—Ä—Ç", "—Ñ–∏—Ç–Ω–µ—Å", "—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏", "gym", "sport", "—Ñ—É—Ç–±–æ–ª", "–±–∞—Å–∫–µ—Ç–±–æ–ª"],
            "—Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ": ["—Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ", "—Ä–∏—Å–æ–≤–∞–Ω–∏–µ", "art", "—Ä–∏—Å—É–µ–º", "–¥–∏–∑–∞–π–Ω", "creative"],
            "—è–∑—ã–∫–∏": ["—è–∑—ã–∫", "english", "language", "—è–∑—ã–∫–∏", "linguistics", "—Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π"]
        }

        for club_type, keywords in club_types.items():
            if any(keyword in message for keyword in keywords):
                return club_type

        return None

    def _get_default_greeting(self) -> str:
        """–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ"""
        return """üëã –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø - AI –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç UnitySphere.

–ü–æ–º–æ–≥—É —Å–æ–∑–¥–∞—Ç—å –≤–∞—à –∫–ª—É–± —á–µ—Ä–µ–∑ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –¥–∏–∞–ª–æ–≥ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.

üí° –ù–∞–ø—Ä–∏–º–µ—Ä, –≤—ã –º–æ–∂–µ—Ç–µ —Å–∫–∞–∑–∞—Ç—å:
‚Ä¢ "–•–æ—á—É —Å–æ–∑–¥–∞—Ç—å –∫–ª—É–± –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è"
‚Ä¢ "–ù—É–∂–µ–Ω —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –∫–ª—É–±"
‚Ä¢ "–ò—â—É —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –∫–ª—É–±"

–ö–∞–∫–æ–π –∫–ª—É–± –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å?"""

    def _classify_club_type(self, message: str) -> Dict[str, str]:
        """–£–ª—É—á—à–µ–Ω–Ω–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–∏–ø–∞ –∫–ª—É–±–∞"""
        tech_keywords = ["–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ", "–∫–æ–¥", "—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞", "it", "tech", "computer", "python", "javascript"]
        creative_keywords = ["—Ä–∏—Å–æ–≤–∞–Ω–∏–µ", "–¥–∏–∑–∞–π–Ω", "art", "—Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ", "creative", "photo", "—Ñ–æ—Ç–æ"]
        sports_keywords = ["—Å–ø–æ—Ä—Ç", "—Ñ–∏—Ç–Ω–µ—Å", "gym", "—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞", "—Ñ—É—Ç–±–æ–ª", "–±–∞—Å–∫–µ—Ç–±–æ–ª", "tennis"]
        language_keywords = ["–∞–Ω–≥–ª–∏–π—Å–∫–∏–π", "language", "—è–∑—ã–∫", "english", "–Ω–µ–º–µ—Ü–∫–∏–π", "—Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π"]

        if any(word in message for word in tech_keywords):
            return {"category": "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏", "count": "156"}
        elif any(word in message for word in creative_keywords):
            return {"category": "–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ", "count": "98"}
        elif any(word in message for word in sports_keywords):
            return {"category": "–°–ø–æ—Ä—Ç", "count": "87"}
        elif any(word in message for word in language_keywords):
            return {"category": "–Ø–∑—ã–∫–∏", "count": "45"}
        else:
            return {"category": "–†–∞–∑–Ω—ã–µ", "count": "29"}

    # –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –º–µ—Ç–æ–¥–æ–≤ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞ —Å —É–ª—É—á—à–µ–Ω–∏—è–º–∏
    def _handle_club_type(self, message: str, original_message: str) -> Dict[str, Any]:
        """üè∑Ô∏è –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∫–ª—É–±–∞ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–æ–π"""
        club_type = self._classify_club_type(message)

        response = f"""–û—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä! üéØ

–í—ã –≤—ã–±—Ä–∞–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é: **{club_type['category']}** ({club_type['count']} –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª—É–±–æ–≤)

**–®–∞–≥ 1: –ù–∞–∑–≤–∞–Ω–∏–µ**
–ü—Ä–∏–¥—É–º–∞–π—Ç–µ —è—Ä–∫–æ–µ –∏ –∑–∞–ø–æ–º–∏–Ω–∞—é—â–µ–µ—Å—è –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –≤–∞—à–µ–≥–æ {club_type['category'].lower()} –∫–ª—É–±–∞.

üí° –°–æ–≤–µ—Ç—ã –ø–æ –≤—ã–±–æ—Ä—É –Ω–∞–∑–≤–∞–Ω–∏—è:
‚Ä¢ –ë—É–¥—å—Ç–µ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã –∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã
‚Ä¢ –°–¥–µ–ª–∞–π—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ª–µ–≥–∫–æ –∑–∞–ø–æ–º–∏–Ω–∞—é—â–∏–º—Å—è
‚Ä¢ –û—Ç—Ä–∞–∑–∏—Ç–µ —Å—É—Ç—å –≤–∞—à–µ–≥–æ –∫–ª—É–±–∞

–ö–∞–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤—ã –±—ã –ø—Ä–µ–¥–ª–æ–∂–∏–ª–∏?"""

        self.collected_data['club_type'] = club_type['category']
        self.conversation_state = "name_creation"

        return {
            "response": response,
            "state": self.conversation_state,
            "quick_replies": [
                f"{club_type['category']} –ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è",
                f"{club_type['category']} –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è",
                f"–ö–ª—É–± {club_type['category']}",
                f"{club_type['category']} –°–æ–æ–±—â–µ—Å—Ç–≤–æ"
            ]
        }

    def _handle_name_creation(self, message: str, original_message: str) -> Dict[str, Any]:
        """üìù –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏"""
        club_name = original_message.strip()

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥–ª–∏–Ω—É –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ
        if len(club_name) < 3:
            return {
                "response": "üìù –ù–∞–∑–≤–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏–¥—É–º–∞–π—Ç–µ –±–æ–ª–µ–µ –¥–ª–∏–Ω–Ω–æ–µ –∏ –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (–º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞).",
                "state": self.conversation_state,
                "quick_replies": [
                    "–¢–µ—Ö–Ω–æ –õ–∞–±",
                    "–ö—Ä–µ–∞—Ç–∏–≤ –°—Ç—É–¥–∏—è",
                    "–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –ö–ª—É–±",
                    "–Ø–∑—ã–∫–æ–≤–∞—è –ü–ª–æ—â–∞–¥–∫–∞"
                ]
            }

        response = f"""üéâ –û—Ç–ª–∏—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ: **{club_name}**!

**–®–∞–≥ 2: –û–ø–∏—Å–∞–Ω–∏–µ**
–¢–µ–ø–µ—Ä—å –¥–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≤–∞—à–µ–≥–æ –∫–ª—É–±–∞. –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ:
‚Ä¢ –ß–µ–º –±—É–¥–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å—Å—è –≤–∞—à –∫–ª—É–±?
‚Ä¢ –î–ª—è –∫–æ–≥–æ –æ–Ω –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω?
‚Ä¢ –ö–∞–∫–∏–µ —Ü–µ–ª–∏ —Å—Ç–∞–≤–∏—Ç–µ?

üí° –ü—Ä–∏–º–µ—Ä: "–ö–ª—É–± –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–æ–≤, –≥–¥–µ –º—ã –∏–∑—É—á–∞–µ–º Python, –¥–µ–ª–∏–º—Å—è –æ–ø—ã—Ç–æ–º –∏ —Å–æ–∑–¥–∞–µ–º –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã together."

–ù–∞–ø–∏—à–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ –∫–ª—É–±–∞:"""

        self.collected_data['club_name'] = club_name
        self.conversation_state = "description"

        return {
            "response": response,
            "state": self.conversation_state
        }

    def _handle_description(self, message: str, original_message: str) -> Dict[str, Any]:
        """üìñ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–∏—Å–∞–Ω–∏—è —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π"""
        description = original_message.strip()

        if len(description) < 10:
            return {
                "response": "üìñ –û–ø–∏—Å–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –±–æ–ª–µ–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–º–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤).",
                "state": self.conversation_state
            }

        response = """üìû –û—Ç–ª–∏—á–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ!

**–®–∞–≥ 3: –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è**
–¢–µ–ø–µ—Ä—å –¥–∞–≤–∞–π—Ç–µ –¥–æ–±–∞–≤–∏–º –∫–æ–Ω—Ç–∞–∫—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è —Å–≤—è–∑–∏ —Å –≤–∞–º–∏:

‚Ä¢ Email (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
‚Ä¢ –¢–µ–ª–µ—Ñ–æ–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
‚Ä¢ Telegram/WhatsApp (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ù–∞–ø—Ä–∏–º–µ—Ä: "email@example.com, +7 (707) 123-45-67, @username"

–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à—É –∫–æ–Ω—Ç–∞–∫—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:"""

        self.collected_data['description'] = description
        self.conversation_state = "contacts"

        return {
            "response": response,
            "state": self.conversation_state
        }

    def _handle_contacts(self, message: str, original_message: str) -> Dict[str, Any]:
        """üìû –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π"""
        contacts = original_message.strip()

        # –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è email
        if "@" not in contacts:
            return {
                "response": "üìû –ü–æ—Ö–æ–∂–µ, –≤—ã –∑–∞–±—ã–ª–∏ —É–∫–∞–∑–∞—Ç—å email. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Å email (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ).\n\n–ù–∞–ø—Ä–∏–º–µ—Ä: \"email@example.com, +7 (707) 123-45-67\"",
                "state": self.conversation_state
            }

        response = f"""‚úÖ –û—Ç–ª–∏—á–Ω–æ! –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.

**–®–∞–≥ 4: –§–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä**
–î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏–º –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º:

üìã **{self.collected_data.get('club_name', '–ù–∞–∑–≤–∞–Ω–∏–µ')}"**
üè∑Ô∏è **–¢–∏–ø:** {self.collected_data.get('club_type', '–ù–µ —É–∫–∞–∑–∞–Ω')}
üìñ **–û–ø–∏—Å–∞–Ω–∏–µ:** {self.collected_data.get('description', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}
üìû **–ö–æ–Ω—Ç–∞–∫—Ç—ã:** {contacts}

–í—Å—ë –≤–µ—Ä–Ω–æ? –ì–æ—Ç–æ–≤—ã —Å–æ–∑–¥–∞—Ç—å –∫–ª—É–±?"""

        self.collected_data['contacts'] = contacts
        self.conversation_state = "review"

        return {
            "response": response,
            "state": self.conversation_state,
            "quick_replies": [
                "–î–∞, —Å–æ–∑–¥–∞—Ç—å –∫–ª—É–±!",
                "–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ",
                "–ò–∑–º–µ–Ω–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ",
                "–ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã"
            ]
        }

    def _handle_review(self, message: str, original_message: str) -> Dict[str, Any]:
        """‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞"""
        message_lower = message.lower()

        if any(word in message_lower for word in ["–¥–∞", "–≥–æ—Ç–æ–≤", "—Å–æ–∑–¥–∞—Ç—å", "yes", "–æ–∫"]):
            response = f"""üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è—é! –í–∞—à –∫–ª—É–± "{self.collected_data.get('club_name', '–ù–∞–∑–≤–∞–Ω–∏–µ')}" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!

‚ú® **–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ UnitySphere!**

üìã **–ß—Ç–æ –¥–∞–ª—å—à–µ:**
‚Ä¢ –í–∞—à –∫–ª—É–± –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤
‚Ä¢ –í—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—É—é email
‚Ä¢ –ü–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è –≤—ã —Å–º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –∏ –ø—Ä–∏–≥–ª–∞—à–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤

üöÄ **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
‚Ä¢ –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª—É–±–µ
‚Ä¢ –î–æ–±–∞–≤–ª—è–π—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
‚Ä¢ –ê–∫—Ç–∏–≤–Ω–æ –æ–±—â–∞–π—Ç–µ—Å—å —Å —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏

–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –≤—ã–±—Ä–∞–ª–∏ UnitySphere! üåü

–•–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å –µ—â–µ –æ–¥–∏–Ω –∫–ª—É–±?"""
            self.conversation_state = "confirmation"
        elif "–Ω–∞–∑–≤–∞–Ω–∏–µ" in message_lower:
            response = "üìù –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –≤–∞—à–µ–≥–æ –∫–ª—É–±–∞:"
            self.conversation_state = "name_creation"
        elif "–æ–ø–∏—Å–∞–Ω–∏–µ" in message_lower:
            response = "üìñ –ù–∞–ø–∏—à–∏—Ç–µ –Ω–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≤–∞—à–µ–≥–æ –∫–ª—É–±–∞:"
            self.conversation_state = "description"
        elif "–∫–æ–Ω—Ç–∞–∫—Ç—ã" in message_lower:
            response = "üìû –£–∫–∞–∂–∏—Ç–µ –Ω–æ–≤—É—é –∫–æ–Ω—Ç–∞–∫—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:"
            self.conversation_state = "contacts"
        else:
            response = """ü§î –ù–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª –≤–∞—à –≤—ã–±–æ—Ä.

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ:
‚Ä¢ "–î–∞, —Å–æ–∑–¥–∞—Ç—å –∫–ª—É–±!" - –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
‚Ä¢ "–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ" - –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è
‚Ä¢ "–ò–∑–º–µ–Ω–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ" - –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏—è
‚Ä¢ "–ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã" - –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤"""

        return {
            "response": response,
            "state": self.conversation_state,
            "quick_replies": [
                "–î–∞, —Å–æ–∑–¥–∞—Ç—å –∫–ª—É–±!",
                "–ù–∞—á–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞",
                "–°–ø—Ä–∞–≤–∫–∞",
                "–í—ã–π—Ç–∏"
            ] if self.conversation_state == "confirmation" else [
                "–î–∞, —Å–æ–∑–¥–∞—Ç—å –∫–ª—É–±!",
                "–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ",
                "–ò–∑–º–µ–Ω–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ",
                "–ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã"
            ]
        }

    def _handle_confirmation(self, message: str, original_message: str) -> Dict[str, Any]:
        """üéâ –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∏—è"""
        message_lower = message.lower()

        if any(word in message_lower for word in ["–¥–∞", "–µ—â–µ", "—Å–æ–∑–¥–∞—Ç—å", "–ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å"]):
            # –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–ª—É–±–∞
            self.conversation_state = "greeting"
            self.collected_data = {}

            response = """üöÄ –û—Ç–ª–∏—á–Ω–æ! –î–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º –µ—â–µ –æ–¥–∏–Ω –∫–ª—É–±!

üëã –ü—Ä–∏–≤–µ—Ç! –Ø - AI –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç UnitySphere.
–ü–æ–º–æ–≥—É —Å–æ–∑–¥–∞—Ç—å –≤–∞—à —Å–ª–µ–¥—É—é—â–∏–π –∫–ª—É–±.

–ö–∞–∫–æ–π –∫–ª—É–± –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å –Ω–∞ —ç—Ç–æ—Ç —Ä–∞–∑?"""
            return {
                "response": response,
                "state": self.conversation_state,
                "quick_replies": [
                    "–ö–ª—É–± –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è",
                    "–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –∫–ª—É–±",
                    "–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –∫–ª—É–±",
                    "–¢–≤–æ—Ä—á–µ—Å–∫–∏–π –∫–ª—É–±"
                ]
            }
        else:
            return self._handle_goodbye()

    def _handle_general_questions(self, message: str, original_message: str) -> Dict[str, Any]:
        """‚ùì –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤"""
        # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –æ–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
        response = """ü§î –Ø –ø–æ–Ω—è–ª –≤–∞—à –≤–æ–ø—Ä–æ—Å.

–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ:
‚Ä¢ –°–æ–∑–¥–∞—Ç—å –∫–ª—É–± - –Ω–∞–ø–∏—à–∏—Ç–µ "—Å–æ–∑–¥–∞—Ç—å –∫–ª—É–±" –∏–ª–∏ –æ–ø–∏—à–∏—Ç–µ –∫–∞–∫–æ–π –∫–ª—É–± —Ö–æ—Ç–∏—Ç–µ
‚Ä¢ –ù–∞–π—Ç–∏ –∫–ª—É–±—ã - –Ω–∞–ø–∏—à–∏—Ç–µ "–Ω–∞–π—Ç–∏ –∫–ª—É–±—ã" –∏–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â—É—é —Ç–µ–º–∞—Ç–∏–∫—É
‚Ä¢ –ü–æ–ª—É—á–∏—Ç—å –ø–æ–º–æ—â—å - –Ω–∞–ø–∏—à–∏—Ç–µ "–ø–æ–º–æ—â—å"
‚Ä¢ –í—ã–π—Ç–∏ - –Ω–∞–ø–∏—à–∏—Ç–µ "–ø–æ–∫–∞"

–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å?"""

        return {
            "response": response,
            "state": self.conversation_state,
            "quick_replies": [
                "–°–æ–∑–¥–∞—Ç—å –∫–ª—É–±",
                "–ù–∞–π—Ç–∏ –∫–ª—É–±—ã",
                "–ü–æ–º–æ—â—å",
                "–ü–æ–∫–∞"
            ]
        }

    def _get_default_response(self) -> Dict[str, Any]:
        """–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"""
        return {
            "response": "ü§î –Ø –Ω–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª –≤–∞—à –∑–∞–ø—Ä–æ—Å.\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Ç–æ—á–Ω–∏—Ç–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤.",
            "state": self.conversation_state,
            "quick_replies": [
                "–ü–æ–º–æ—â—å",
                "–°–æ–∑–¥–∞—Ç—å –∫–ª—É–±",
                "–ù–∞–π—Ç–∏ –∫–ª—É–±—ã",
                "–ü–æ–∫–∞"
            ]
        }


# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–µ
def process_ai_message(message: str, session_id: str = "default", history: List[Dict] = None) -> Dict[str, Any]:
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π"""
    agent = EnhancedAIConsultant()
    return agent.process_message(message, session_id, history)