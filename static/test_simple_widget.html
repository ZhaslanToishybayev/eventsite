<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç AI –≤–∏–¥–∂–µ—Ç–∞</title>
    <link rel="stylesheet" href="/static/css/ai-chat-widget-v2.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f0f0f0;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        #widget-status {
            font-family: monospace;
            font-size: 14px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            white-space: pre-line;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîç –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç AI –≤–∏–¥–∂–µ—Ç–∞</h1>

        <div class="status info">
            <strong>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong> –≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –±–∞–∑–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å AI –≤–∏–¥–∂–µ—Ç–∞.
        </div>

        <div id="loading-status">
            <div class="status info">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <div id="widget-status"></div>

        <div>
            <button onclick="testWidgetCreation()">üîß –°–æ–∑–¥–∞—Ç—å –≤–∏–¥–∂–µ—Ç –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ</button>
            <button onclick="testWidgetVisibility()">üëÅÔ∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—å</button>
            <button onclick="forceShowButton()">‚ö° –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É</button>
            <button onclick="clearStatus()">üßπ –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
        </div>

        <div class="status info">
            <strong>–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</strong> –í –ø—Ä–∞–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É –¥–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –∫—Ä—É–≥–ª–∞—è –∫–Ω–æ–ø–∫–∞ —Å –∏–∫–æ–Ω–∫–æ–π ‚ú® –∏ –∑–µ–ª–µ–Ω–æ–π —Ç–æ—á–∫–æ–π –æ–Ω–ª–∞–π–Ω-—Å—Ç–∞—Ç—É—Å–∞.
        </div>
    </div>

    <script src="/static/js/ai-chat-widget-v2.js"></script>

    <script>
        let statusDiv = document.getElementById('widget-status');
        let loadingDiv = document.getElementById('loading-status');

        function updateStatus(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `status ${type}`;
            entry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;

            if (loadingDiv) {
                loadingDiv.style.display = 'none';
            }

            statusDiv.appendChild(entry);
            statusDiv.scrollTop = statusDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function checkBasicStatus() {
            updateStatus('üöÄ –ù–∞—á–∞–ª–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∏–¥–∂–µ—Ç–∞...', 'info');

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
            const checks = [
                { name: 'AIChatWidget –∫–ª–∞—Å—Å', check: typeof AIChatWidget !== 'undefined' },
                { name: 'initAIChatWidgetV2 —Ñ—É–Ω–∫—Ü–∏—è', check: typeof initAIChatWidgetV2 === 'function' },
                { name: 'window.aiChatWidgetV2', check: !!window.aiChatWidgetV2 },
                { name: 'CSS —Ñ–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω', check: !!document.querySelector('link[href*="ai-chat-widget"]') },
                { name: 'JS —Ñ–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω', check: !!document.querySelector('script[src*="ai-chat-widget"]') }
            ];

            let allPassed = true;
            checks.forEach(item => {
                if (item.check) {
                    updateStatus(`‚úÖ ${item.name}: –î–æ—Å—Ç—É–ø–µ–Ω`, 'success');
                } else {
                    updateStatus(`‚ùå ${item.name}: –ù–µ –Ω–∞–π–¥–µ–Ω`, 'error');
                    allPassed = false;
                }
            });

            return allPassed;
        }

        function checkDOMElements() {
            updateStatus('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤...', 'info');

            const widget = document.getElementById('ai-chat-widget');
            const button = document.getElementById('chatToggleBtn');

            if (widget) {
                updateStatus('‚úÖ –í–∏–¥–∂–µ—Ç (#ai-chat-widget): –ù–∞–π–¥–µ–Ω –≤ DOM', 'success');

                const styles = window.getComputedStyle(widget);
                const rect = widget.getBoundingClientRect();

                updateStatus(`üé® –°—Ç–∏–ª–∏ –≤–∏–¥–∂–µ—Ç–∞:
  Display: ${styles.display}
  Visibility: ${styles.visibility}
  Opacity: ${styles.opacity}
  Position: ${styles.position}
  Bottom: ${styles.bottom}
  Right: ${styles.right}
  Z-Index: ${styles.zIndex}
  Width: ${styles.width}
  Height: ${styles.height}`, 'info');

                updateStatus(`üìê –ü–æ–∑–∏—Ü–∏—è –≤–∏–¥–∂–µ—Ç–∞:
  Top: ${rect.top}px
  Left: ${rect.left}px
  Width: ${rect.width}px
  Height: ${rect.height}px
  –í–∏–¥–∏–º—ã–π: ${rect.width > 0 && rect.height > 0 ? '–î–∞' : '–ù–µ—Ç'}`, rect.width > 0 && rect.height > 0 ? 'success' : 'error');

            } else {
                updateStatus('‚ùå –í–∏–¥–∂–µ—Ç (#ai-chat-widget): –ù–µ –Ω–∞–π–¥–µ–Ω –≤ DOM', 'error');
            }

            if (button) {
                updateStatus('‚úÖ –ö–Ω–æ–ø–∫–∞ (#chatToggleBtn): –ù–∞–π–¥–µ–Ω–∞ –≤ DOM', 'success');

                const styles = window.getComputedStyle(button);
                const rect = button.getBoundingClientRect();

                updateStatus(`üé® –°—Ç–∏–ª–∏ –∫–Ω–æ–ø–∫–∏:
  Display: ${styles.display}
  Visibility: ${styles.visibility}
  Opacity: ${styles.opacity}
  Background: ${styles.background}`, 'info');

                updateStatus(`üìê –ü–æ–∑–∏—Ü–∏—è –∫–Ω–æ–ø–∫–∏:
  Top: ${rect.top}px
  Left: ${rect.left}px
  Width: ${rect.width}px
  Height: ${rect.height}px
  –í–∏–¥–∏–º–∞: ${rect.width > 0 && rect.height > 0 ? '–î–∞' : '–ù–µ—Ç'}`, rect.width > 0 && rect.height > 0 ? 'success' : 'error');

            } else {
                updateStatus('‚ùå –ö–Ω–æ–ø–∫–∞ (#chatToggleBtn): –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ DOM', 'error');
            }

            return !!(widget && button);
        }

        function testWidgetCreation() {
            updateStatus('üîß –ü–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–¥–∂–µ—Ç–∞...', 'info');

            try {
                if (typeof initAIChatWidgetV2 === 'function') {
                    const widget = initAIChatWidgetV2();
                    updateStatus(`‚úÖ –í–∏–¥–∂–µ—Ç —Å–æ–∑–¥–∞–Ω —á–µ—Ä–µ–∑ initAIChatWidgetV2(): ${widget ? '–£—Å–ø–µ—à–Ω–æ' : '–û—à–∏–±–∫–∞'}`, widget ? 'success' : 'error');

                    setTimeout(() => {
                        checkDOMElements();
                    }, 1000);
                } else {
                    updateStatus('‚ùå –§—É–Ω–∫—Ü–∏—è initAIChatWidgetV2 –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
                }
            } catch (error) {
                updateStatus(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≤–∏–¥–∂–µ—Ç–∞: ${error.message}`, 'error');
            }
        }

        function testWidgetVisibility() {
            updateStatus('üëÅÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –≤–∏–¥–∂–µ—Ç–∞...', 'info');
            checkDOMElements();
        }

        function forceShowButton() {
            updateStatus('‚ö° –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ –≤–∏–¥–∂–µ—Ç–∞ —Å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏...', 'info');

            try {
                if (typeof initAIChatWidgetV2 === 'function') {
                    updateStatus('üîß –ò—Å–ø–æ–ª—å–∑—É–µ–º initAIChatWidgetV2...', 'info');
                    const widget = initAIChatWidgetV2();

                    setTimeout(() => {
                        const button = document.getElementById('chatToggleBtn');
                        const container = document.getElementById('chatContainer');

                        if (button && widget && widget.toggleChat) {
                            updateStatus('‚úÖ –í–∏–¥–∂–µ—Ç –∏ –∫–Ω–æ–ø–∫–∞ –Ω–∞–π–¥–µ–Ω—ã, –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫...', 'info');

                            // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                            button.onclick = (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                updateStatus('üéØ –ö–Ω–æ–ø–∫–∞ –Ω–∞–∂–∞—Ç–∞! –í—ã–∑—ã–≤–∞–µ–º toggleChat...', 'info');

                                try {
                                    widget.toggleChat();
                                    updateStatus('‚úÖ toggleChat –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                                } catch (error) {
                                    updateStatus(`‚ùå –û—à–∏–±–∫–∞ –≤ toggleChat: ${error.message}`, 'error');
                                }
                            };

                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —á–∞—Ç–∞
                            if (!container) {
                                updateStatus('‚ö†Ô∏è –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º HTML...', 'info');
                            } else {
                                updateStatus('‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–∞—Ç–∞ –Ω–∞–π–¥–µ–Ω!', 'success');
                            }

                            updateStatus('‚úÖ –ö–Ω–æ–ø–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∞ —Å —Ä–∞–±–æ—á–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–º!', 'success');
                        } else {
                            updateStatus(`‚ùå –û—à–∏–±–∫–∞: –≤–∏–¥–∂–µ—Ç=${!!widget}, –∫–Ω–æ–ø–∫–∞=${!!button}, toggleChat=${!!widget?.toggleChat}`, 'error');
                        }
                    }, 1000);
                } else {
                    updateStatus('‚ùå –§—É–Ω–∫—Ü–∏—è initAIChatWidgetV2 –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!', 'error');
                }
            } catch (error) {
                updateStatus(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≤–∏–¥–∂–µ—Ç–∞: ${error.message}`, 'error');
            }

            setTimeout(() => {
                checkDOMElements();
            }, 2000);
        }

        function clearStatus() {
            statusDiv.innerHTML = '';
            loadingDiv.style.display = 'block';
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –Ω–∞—á–∏–Ω–∞—é —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...', 'info');

            setTimeout(() => {
                const basicOK = checkBasicStatus();

                if (basicOK) {
                    updateStatus('‚úÖ –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞, –ø—Ä–æ–≤–µ—Ä—è—é DOM...', 'success');
                    setTimeout(() => {
                        const domOK = checkDOMElements();

                        if (!domOK) {
                            updateStatus('‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã —Å DOM —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ', 'error');
                        }
                    }, 2000);
                } else {
                    updateStatus('‚ùå –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞', 'error');
                }
            }, 1000);
        });

        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
        window.addEventListener('error', function(event) {
            updateStatus(`‚ùå JavaScript –æ—à–∏–±–∫–∞: ${event.error.message}`, 'error');
        });

        window.addEventListener('unhandledrejection', function(event) {
            updateStatus(`‚ö†Ô∏è Promise –æ—à–∏–±–∫–∞: ${event.reason}`, 'error');
        });
    </script>
</body>
</html>